"use strict";function loadAdventures(){var a={Main:{adv0:new AdventureDef({displayName:"Field",areaType:"grass",subAreas:[{level:2},{level:2},{level:3}],allEnemies:{snake:100},allLevelRand:1,spawnCountHi:3}),adv1:new AdventureDef({prereqs:{adventures:["adv0"]},displayName:"Plain",areaType:"grass",subAreas:[{level:4},{level:5},{level:5},{level:7}],allEnemies:{snake:50,slug:50}}),adv2:new AdventureDef({prereqs:{adventures:["adv1"]},displayName:"Grasslands",areaType:"grass",subAreas:[{level:8},{level:10},{level:11},{level:11},{level:10,enemies:{snake3:8}},{level:14,useAll:!1,spawnLo:1,spawnHi:1,enemies:{trisnake:100}}],allEnemies:{snake:40,slug:30,snake2:30,snake3:1}}),adv3:new AdventureDef({prereqs:{adventures:["adv2"]},displayName:"Desert",areaType:"sand",subAreas:[{level:18,useAll:!1,enemies:{mask:100}},{level:20},{level:21},{level:23}],allEnemies:{mask:50,shell:50}}),adv4:new AdventureDef({prereqs:{adventures:["adv3"]},displayName:"Dune",areaType:"sand",subAreas:[{level:26,useAll:!1,enemies:{mask:100}},{level:29},{level:32}],allEnemies:{mask:30,shell:40,slug2:30}}),adv5:new AdventureDef({prereqs:{adventures:["adv4"]},displayName:"Sand Sea",areaType:"sand",subAreas:[{level:42},{level:44},{level:45,enemies:{shell2:35}},{level:45,enemies:{shell2:35}},{level:44,enemies:{shell2:35,mask3:8}},{level:49,useAll:!1,spawnLo:1,spawnHi:1,enemies:{trisnake2:100}}],allEnemies:{mask2:45,shell:15,slug2:20,mask3:1}}),adv6:new AdventureDef({prereqs:{adventures:["adv5"]},displayName:"Forest",areaType:"forest",subAreas:[{level:80,useAll:!1,enemies:{spider:100}},{level:84},{level:87},{level:89}],allEnemies:{spider:50,snap:50}}),adv7:new AdventureDef({prereqs:{adventures:["adv6"]},displayName:"Grove",areaType:"forest",subAreas:[{level:95},{level:99},{level:101},{level:102}],allEnemies:{spider:15,spider2:45,snap:30}})},Extra:{sid1:new AdventureDef({prereqs:{adventures:["adv0"]},displayName:"Meadow",areaType:"grass",subAreas:[{level:8,enemies:{snake:50}},{level:9}],allEnemies:{slug:100},spawnCountLo:4,spawnCountHi:5,clearMessage:"Found a Blacksmith"}),sid2:new AdventureDef({prereqs:{adventures:["sid1"]},displayName:"Hut",areaType:"house",subAreas:[{level:30},{level:35},{level:40}],allEnemies:{snake2:40,slug2:80,mask2:30},spawnCountLo:5,spawnCountHi:6,clearMessage:"Logger now available"}),sid0:new AdventureDef({prereqs:{adventures:["adv4"]},displayName:"Oasis",areaType:"grass",subAreas:[{level:70},{level:75}],allEnemies:{snake2:35,slug2:30,shell:35,snake3:1},spawnCountLo:6,spawnCountHi:7}),sid3:new AdventureDef({prereqs:{adventures:["adv6"]},displayName:"Cabin",areaType:"dark-house",subAreas:[{level:200,enemies:{spider:100}},{level:200,enemies:{spider2:100}}],allEnemies:{},spawnCountLo:7,spawnCountHi:8,clearMessage:"Lightning Rod now available"})},OSTM:{ostm:new AdventureDef({prereqs:{adventures:["adv7"]},displayName:"Oh Shit, There's More",areaType:"forest",subAreas:[{level:120},{level:121}],allEnemies:{snake2:35,slug2:30,shell:35,snail:20,mask2:35,snake3:3,mask3:3,spider:15,spider2:45,snap:30},spawnCountLo:6,spawnCountHi:9})}};for(var b in a)for(var c in a[b]){var d=a[b][c];d.name=c,d.category=b}return a}function loadBuffs(){var a={xp:new BuffDef({displayName:"XP Bonus",effects:{xpIncome:{base:10,level:1}}}),gold:new BuffDef({displayName:"Gold Bonus",effects:{goldIncome:{base:10,level:1}}}),healthRegen:new BuffDef({displayName:"Health Bonus",effects:{healthRegen:{base:5,level:.5}}}),manaRegen:new BuffDef({displayName:"Mana Bonus",effects:{manaRegen:{base:5,level:.5}}}),damage:new BuffDef({displayName:"Damage Bonus",effects:{damage:{base:5,level:.5}}})};return foreach(a,function(a,b){a.name=b}),a}function loadBuildings(){var a=15,b=25,c={Residences:{tent:new BuildingDef({displayName:"Tent",baseCost:100,resourcePerSecond:1}),shack:new BuildingDef({displayName:"Shack",baseCost:2e3,resourcePerSecond:6,prereqs:{adventures:["adv1"]}}),cabin:new BuildingDef({displayName:"Cabin",baseCost:11500,resourcePerSecond:18,prereqs:{adventures:["adv1"]}}),cottage:new BuildingDef({displayName:"Cottage",baseCost:5e4,researchCost:750,resourcePerSecond:45,prereqs:{adventures:["adv2"]}}),house:new BuildingDef({displayName:"House",baseCost:32e4,researchCost:1500,resourcePerSecond:140,prereqs:{adventures:["adv2"]}}),manor:new BuildingDef({displayName:"Manor",baseCost:24e5,researchCost:5e3,resourcePerSecond:500,prereqs:{adventures:["adv2"]}}),dorm:new BuildingDef({displayName:"Dormitory",baseCost:26e6,researchCost:15e3,resourcePerSecond:2e3,prereqs:{adventures:["adv6"]}}),apartment:new BuildingDef({displayName:"Apartment",baseCost:149e6,researchCost:32500,resourcePerSecond:4500,prereqs:{adventures:["adv6"]}}),condo:new BuildingDef({displayName:"Condominium",baseCost:49995e4,researchCost:75e3,resourcePerSecond:9500,prereqs:{adventures:["adv6"]}})},Research:{"research-center":new BuildingDef({displayName:"Research Center",description:"Researches new things",baseCost:500,resourceProduced:"research",resourcePerSecond:1,maxCount:1}),library:new BuildingDef({displayName:"Library",baseCost:350,costIncreasePercent:a,researchCost:50,resourceProduced:"research",resourcePerSecond:.2,prereqs:{buildings:{"research-center":1}}}),school:new BuildingDef({displayName:"School",baseCost:7500,costIncreasePercent:a,researchCost:250,resourceProduced:"research",resourcePerSecond:.75,prereqs:{buildings:{library:0}}}),university:new BuildingDef({displayName:"University",baseCost:15e4,costIncreasePercent:a,researchCost:1e3,resourceProduced:"research",resourcePerSecond:1.5,prereqs:{buildings:{school:0}}}),sciFactory:new BuildingDef({displayName:"Science Factory",baseCost:2e6,costIncreasePercent:a,researchCost:3500,resourceProduced:"research",resourcePerSecond:3,prereqs:{buildings:{university:0}}}),observatory:new BuildingDef({displayName:"Observatory",baseCost:85e5,costIncreasePercent:a,researchCost:25e3,resourceProduced:"research",resourcePerSecond:5,prereqs:{buildings:{sciFactory:0}}})},Workshops:{anvil:new BuildingDef({displayName:"Anvil",description:"Blacksmith can Upgrade weapons",baseCost:25e3,maxCount:1,prereqs:{adventures:["sid1"]}}),forge:new BuildingDef({displayName:"Mystic Forge",description:"Blacksmith can Ascend max-level weapons",researchCost:200,baseCost:5e4,maxCount:1,prereqs:{buildings:{anvil:1}}}),foundry:new BuildingDef({displayName:"Foundry",researchCost:5e3,baseCost:25e4,costIncreasePercent:b,resourceProduced:"iron",resourcePerSecond:3,prereqs:{buildings:{forge:1}}}),ironworks:new BuildingDef({displayName:"Ironworks",researchCost:5e3,baseCost:175e4,costIncreasePercent:b,resourceProduced:"iron",resourcePerSecond:5,prereqs:{buildings:{foundry:1}}}),logger:new BuildingDef({displayName:"Logger",description:"Unlocks building upgrades",baseCost:500,maxCount:1,prereqs:{adventures:["sid2"]}}),lumberjack:new BuildingDef({displayName:"Lumberjack",researchCost:5e3,baseCost:5e5,costIncreasePercent:b,resourceProduced:"wood",resourcePerSecond:1.5,prereqs:{buildings:{logger:1}}}),"training-hall":new BuildingDef({displayName:"Training Hall",description:"Unlocks Skills",researchCost:500,baseCost:25e3,maxCount:1}),"wizard-tower":new BuildingDef({displayName:"Wizard's Tower",description:"Unlocks Spells",researchCost:7500,baseCost:1e5,maxCount:1,prereqs:{buildings:{"training-hall":1}}})}},d={};return foreach(c,function(a,b){foreach(a,function(a,c){a.name=c,a.sectionName=b,d[c]=a})}),d}function loadEnemies(){var a={snake:new EnemyDef({displayName:"Snake",image:"Snake.png",health:22,attack:6,reward:{xp:8,gold:5}}),slug:new EnemyDef({displayName:"Sloog",image:"SlugSquirrel.png",health:40,attack:4,reward:{xp:10,gold:6}}),snake2:new EnemyDef({displayName:"Snake-2",image:"Snake2.png",health:55,attack:7,reward:{xp:13,gold:8,wood:.7}}),snake3:new EnemyDef({displayName:"Snake-3",image:"Snake3.png",health:255,attack:12,reward:{xp:28,gold:45,wood:6}}),trisnake:new EnemyDef({displayName:"TriSnake",image:"TriSnake2.png",boss:!0,health:1050,attack:4.5,reward:{xp:80,gold:25}}),mask:new EnemyDef({displayName:"Masker",image:"MaskBug.png",health:90,attack:8,reward:{xp:18,gold:7,iron:3}}),shell:new EnemyDef({displayName:"Sheller",image:"ShellBug.png",health:110,attack:7,reward:{xp:19,gold:11}}),slug2:new EnemyDef({displayName:"Sloog-2",image:"SlugSquirrel2.png",health:140,attack:7,reward:{xp:24,gold:9}}),mask2:new EnemyDef({displayName:"Masker-2",image:"MaskBug2.png",health:160,attack:11,reward:{xp:24,gold:11,iron:4.5}}),shell2:new EnemyDef({displayName:"Sheller-2",image:"ShellBug2.png",health:210,attack:9,reward:{xp:25,gold:12,wood:1.4}}),mask3:new EnemyDef({displayName:"Masker-3",image:"MaskBug3.png",health:1200,attack:20,reward:{xp:70,gold:27,iron:23,wood:11}}),trisnake2:new EnemyDef({displayName:"TriSnake-2",image:"TriSnake.png",boss:!0,health:4500,attack:16,reward:{xp:180,gold:125}}),spider:new EnemyDef({displayName:"Spider",image:"Spider.png",health:400,attack:31,reward:{xp:44,gold:33}}),snap:new EnemyDef({displayName:"Snapper",image:"SnapPlant.png",health:480,attack:25,reward:{xp:40,gold:23,wood:2.2}}),spider2:new EnemyDef({displayName:"Spider-2",image:"Spider2.png",health:650,attack:38,reward:{xp:54,gold:41}}),snail:new EnemyDef({displayName:"Snale",image:"SpikeSnail.png",health:450,attack:26,reward:{xp:45,gold:28}})};return foreach(a,function(a,b){a.name=b}),a}function loadItems(){var a={potion:new PotionDef({displayName:"Potion",count:1,curCount:1,healAmount:100,baseCost:100}),hiPotion:new PotionDef({displayName:"Hi-Potion",healAmount:500,baseCost:5e3,researchCost:250,prereqs:{adventures:["adv1"]}}),superPotion:new PotionDef({displayName:"Super Potion",healAmount:2500,baseCost:1e5,researchCost:1500,prereqs:{adventures:["adv2"],items:["hiPotion"]}}),megaPotion:new PotionDef({displayName:"Mega Potion",healAmount:15e3,baseCost:35e5,researchCost:5e3,prereqs:{adventures:["adv3"],items:["superPotion"]}}),ether:new PotionDef({displayName:"Ether",manaAmount:75,baseCost:1e4,researchCost:1e3,prereqs:{items:["hiPotion"]}}),hiEther:new PotionDef({displayName:"Hi-Ether",manaAmount:300,baseCost:18e4,researchCost:5e3,prereqs:{adventures:["adv3"],items:["ether"]}}),elixir:new PotionDef({displayName:"Elixir",healAmount:1500,manaAmount:200,baseCost:15e4,researchCost:15e3,prereqs:{adventures:["adv4"],items:["superPotion","hiEther"]}}),"armor-plus":new ItemDef({storeName:"Upgrade Armor",description:"Increases Armor by 1",isCountLimited:!1,update:function(){Player.armor=this.count+2},baseCost:50,currency:"iron",getCost:function(){return this.baseCost*(1+Math.floor(Math.pow(this.count,1.8)))},prereqs:{buildings:{forge:1}}})};for(var b in a)a[b].name=b;return a}function loadSkills(){var a={attack:new AttackSkillDef({displayName:"Attack",keyCode:"a",baseDamage:100,levelDamage:5,level:1}),"power-attack":new AttackSkillDef({displayName:"Power Attack",keyCode:"1",manaCost:6,baseDamage:200,levelDamage:40}),"quick-attack":new AttackSkillDef({displayName:"Quick Attack",keyCode:"2",description:"+50% chance to critically strike",bonuses:{crit:50},manaCost:7,baseDamage:120,levelDamage:15}),whirlwind:new AttackSkillDef({displayName:"Whirlwind",keyCode:"3",description:"Hits all enemies on screen",manaCost:15,baseDamage:80,levelDamage:10,doAttack:function(){for(var a=EnemyManager.activeEnemies.length-1;a>=0;a--){var b=EnemyManager.activeEnemies[a];b.takeDamage(Player.getDamageInfo())}}}),"magic-missile":new SpellSkillDef({displayName:"Magic Missile",keyCode:"4",manaCost:8,baseDamage:200,levelDamage:50,baseCrit:5}),fireBolt:new SpellSkillDef({keyCode:"5",displayName:"Fire Bolt",manaCost:18,baseDamage:350,levelDamage:75,baseCrit:4}),lightningBolt:new SpellSkillDef({keyCode:"6",displayName:"Lightning Bolt",description:"100% higher max damage",bonuses:{maxDamage:100},manaCost:16,baseDamage:200,levelDamage:40,baseCrit:6}),fireball:new SpellSkillDef({displayName:"Fireball",keyCode:"7",description:"Hits all enemies on screen, enemies closer to target take more damage",manaCost:36,baseDamage:140,levelDamage:18,baseCrit:3,doAttack:function(a){var b=a.getAbsolutePosition(),c=250,d=32,e=.2,f=.6,g=.85,h=.35;ParticleContainer.createEffect("Explosion.png",{x:b.x+(b.w-c)/2+randIntInc(-d,d),y:b.y+(b.h-c)/2+randIntInc(-d,d),w:c,h:c}),a.takeDamage(Player.getDamageInfo());for(var i=EnemyManager.activeEnemies.length-1;i>=0;i--){var j=EnemyManager.activeEnemies[i];if(j!=a){var k=distance(a.x,a.y,j.x,j.y),l=lerp((k-e)/(f-e),g,h);j.takeDamage(Player.getDamageInfo(l))}}}}),chainLightning:new SpellSkillDef({displayName:"Chain Lightning",keyCode:"8",description:"Hits all enemies on screen, does 20% less damage with each bounce",manaCost:28,baseDamage:150,levelDamage:20,baseCrit:7,doAttack:function(){var a=50,b=.8,c=function(b,c){var d=16,e=b.getAbsolutePosition(),f=c.getAbsolutePosition();e.x+=e.w/2+randIntInc(-d,d),e.y+=e.h/2+randIntInc(-d,d),f.x+=f.w/2+randIntInc(-d,d),f.y+=f.h/2+randIntInc(-d,d);var g=vecDistance(e,f);ParticleContainer.createEffect("Lightning.png",{x:(e.x+f.x-a)/2,y:(e.y+f.y-g)/2,w:a,h:g,deg:90+180/Math.PI*Math.atan2(f.y-e.y,f.x-e.x),fadeTime:250})},d=function(a,e,f){var g=null,h=0;foreach(EnemyManager.activeEnemies,function(b){if(-1===e.indexOf(b)){var c=distance(a.x,a.y,b.x,b.y);(!g||h>c)&&(g=b,h=c)}}),g&&(c(a,g),d(g,e.concat(g),f*b)),a.takeDamage(Player.getDamageInfo(f))};return function(a){d(a,[a],1)}}()}),"health-up":new PassiveSkillDef({displayName:"Health Plus",description:"Increases Max Health by <mult.maxHealth>%",statMult:{maxHealth:{base:10,level:5}}}),"health-scale":new PassiveSkillDef({displayName:"Health Mastery",description:"Increases Max Health by <mult.healthPerLevel>% per Player Level",statMult:{healthPerLevel:{base:.025,level:.005}}}),fortitude:new PassiveSkillDef({displayName:"Fortitude",description:"Increases overall Health Regen by <mult.healthRegen>%",statMult:{healthRegen:{base:20,level:5}}}),heartiness:new PassiveSkillDef({displayName:"Heartiness",description:"Restores Health by <base.healthRegen>% of Max Health every second",statBase:{healthRegen:{base:1,level:.1}}}),"mana-up":new PassiveSkillDef({displayName:"Mana Plus",description:"Increases Max Mana by <mult.maxMana>%",statMult:{maxMana:{base:12,level:6}}}),focus:new PassiveSkillDef({displayName:"Focus",description:"Increases overall Mana Regen by <mult.manaRegen>%",statMult:{manaRegen:{base:25,level:6}}}),"crystal-mind":new PassiveSkillDef({displayName:"Crystal Mind",description:"Restores Mana by <base.manaRegen>% of Max Mana every second",statBase:{manaRegen:{base:1.5,level:.15}}}),spellSword:new PassiveSkillDef({displayName:"Spell Sword",description:"Restores <base.attackMana> MP with every standard Attack",statBase:{attackMana:{base:3,level:2}}}),precision:new PassiveSkillDef({displayName:"Precision",description:"Increase base Crit Chance by <base.crit>%",statBase:{crit:{base:.5,level:.075}}}),ruthlessness:new PassiveSkillDef({displayName:"Ruthlessness",description:"Increase overall Crit Chance by <mult.crit>%",statMult:{crit:{base:6,level:1.25}}}),cruelty:new PassiveSkillDef({displayName:"Cruelty",description:"Adds <base.critDamage>% Crit Damage and increases Attack Power by <mult.damage>%",statBase:{critDamage:{base:20,level:4}},statMult:{attack:{level:1}}}),power:new PassiveSkillDef({displayName:"Power",description:"Increases Damage by <mult.damage>%",statMult:{damage:{base:2,level:1}}}),alchemy:new PassiveSkillDef({displayName:"Alchemy",description:"Increases item effectiveness by <mult.itemEffeciency>%",statMult:{itemEffeciency:{base:100,level:25}}})};return foreach(a,function(a,b){a.name=b}),a}function loadStats(){var a={maxHealth:new StatType({displayName:"Vitality",description:"Increase health by <bonus> per level (<totalBonus> total)",baseValue:5,bonus:20,onUpgrade:function(){Player.regenHealth(this.upgradeValue())}}),maxMana:new StatType({displayName:"Spirit",description:"Increase mana by <bonus> per level (<totalBonus> total)",baseValue:5,bonus:7,prereqs:{buildings:{"training-hall":1}},onUpgrade:function(){Player.regenMana(this.upgradeValue())}}),strength:new StatType({displayName:"Strength",abbrev:"STR",description:"Increases Attack Power by <bonus>% per level (+<totalBonus>% total)",baseValue:4,bonus:.25,prereqs:{playerLevel:2}}),dexterity:new StatType({displayName:"Dexterity",abbrev:"DEX",description:"Increases Crit Damage by <bonus>% per level (+<totalBonus>% total)",baseValue:5,bonus:.5,prereqs:{buildings:{blacksmith:1}}}),intelligence:new StatType({displayName:"Intelligence",abbrev:"INT",description:"Increases Spell Power by <bonus>% per level (+<totalBonus>% total)",baseValue:3,bonus:.5,prereqs:{buildings:{"wizard-tower":1}}}),wisdom:new StatType({displayName:"Wisdom",abbrev:"WIS",description:"Increases mana regen by <bonus>/s per level (+<totalBonus> total)",baseValue:3,bonus:.15,prereqs:{buildings:{"wizard-tower":1}}}),defense:new StatType({displayName:"Defense",abbrev:"DEF",description:"Increases health regen by <bonus>/s per level (+<totalBonus> total)",baseValue:3,bonus:.25,prereqs:{adventures:["adv0"]}})};for(var b in a)a[b].name=b;return a}function loadUpgrades(){var a={"tent-1":new UpgradeDef({displayName:"Big Tents",baseCost:100,targetBuilding:"tent",amountIncrease:50,prereqs:{buildings:{tent:1}}}),"tent-2":new UpgradeDef({displayName:"Bigger Tents",baseCost:400,targetBuilding:"tent",amountIncrease:50,prereqs:{buildings:{tent:5}}}),"tent-3":new UpgradeDef({displayName:"Nice Tents",researchCost:700,baseCost:2e3,targetBuilding:"tent",amountIncrease:100,prereqs:{buildings:{tent:10}}}),"tent-4":new UpgradeDef({displayName:"Real Nice Tents",researchCost:1500,baseCost:5e3,targetBuilding:"tent",amountIncrease:50,prereqs:{buildings:{tent:20}}}),"tent-n":new UpgradeDef({displayName:"Infinite Tents",researchCost:5e4,baseCost:1e4,targetBuilding:"tent",amountIncrease:2,maxCount:0,prereqs:{buildings:{tent:50}}}),"shack-1":new UpgradeDef({displayName:"Dry Shacks",baseCost:500,targetBuilding:"shack",amountIncrease:50,prereqs:{buildings:{shack:1}}}),"shack-2":new UpgradeDef({displayName:"Painted Shack",baseCost:3500,targetBuilding:"shack",amountIncrease:75,prereqs:{buildings:{shack:10}}}),"cabin-1":new UpgradeDef({displayName:"Log Cabins",baseCost:2e3,targetBuilding:"cabin",amountIncrease:50,prereqs:{buildings:{cabin:1}}}),"cabin-2":new UpgradeDef({displayName:"Doors",baseCost:12e3,targetBuilding:"cabin",amountIncrease:100,prereqs:{buildings:{cabin:10}}}),"cottage-1":new UpgradeDef({displayName:"Fireplaces",baseCost:5e3,targetBuilding:"cottage",amountIncrease:50,prereqs:{buildings:{cottage:1}}}),"cottage-2":new UpgradeDef({displayName:"Chimneys",baseCost:4e4,targetBuilding:"cottage",amountIncrease:100,prereqs:{buildings:{cottage:10}}}),"cottage-3":new UpgradeDef({displayName:"Cozy Fireplaces",baseCost:18e4,targetBuilding:"cottage",amountIncrease:50,prereqs:{buildings:{cottage:20}}}),"house-1":new UpgradeDef({displayName:"Windows",baseCost:15e3,targetBuilding:"house",amountIncrease:50,prereqs:{buildings:{house:1}}}),"house-2":new UpgradeDef({displayName:"Decks",baseCost:125e3,targetBuilding:"house",amountIncrease:100,prereqs:{buildings:{house:10}}}),"manor-1":new UpgradeDef({displayName:"Landscaping",baseCost:5e4,targetBuilding:"manor",amountIncrease:50,prereqs:{buildings:{manor:1}}}),"manor-2":new UpgradeDef({displayName:"Serfs",baseCost:65e4,targetBuilding:"manor",amountIncrease:100,prereqs:{buildings:{manor:10}}}),"library-1":new UpgradeDef({displayName:"Card Catalogs",baseCost:1200,targetBuilding:"library",amountIncrease:100,prereqs:{buildings:{library:1}}})};return foreach(a,function(a,b){a.name=b}),a}function loadWeaponTypes(){var a={dagger:new WeaponTypeDef({displayName:"Dagger",upgradeData:{crit:7,critDamage:4}}),sword:new WeaponTypeDef({displayName:"Sword",upgradeData:{attack:5,crit:6}}),sword2h:new WeaponTypeDef({displayName:"Greatsword",upgradeData:{attack:4,maxHealth:2,defense:3}}),axe:new WeaponTypeDef({displayName:"Axe",upgradeData:{attack:6,critDamage:3}}),wand:new WeaponTypeDef({displayName:"Wand",upgradeData:{spellPower:3,manaRegen:6}}),staff:new WeaponTypeDef({displayName:"Staff",upgradeData:{spellPower:6,maxMana:3}}),mace:new WeaponTypeDef({displayName:"Mace",upgradeData:{damage:4,healthRegen:3}})};return foreach(a,function(a,b){a.name=b}),a}function loadWeapons(){var a={stick:new WeaponDef({displayName:"Stick",type:"wand",owned:!0,scalingBase:{strength:40},damage:4,spellPower:7,crit:3,upgradeData:{damage:5}}),knife:new WeaponDef({displayName:"Knife",type:"dagger",scalingBase:{dexterity:70},buyCost:250,damage:8,spellPower:5,crit:9,upgradeData:{crit:10,critDamage:10}}),dagger:new WeaponDef({displayName:"Dagger",type:"dagger",scalingBase:{dexterity:60},buyCost:2e3,damage:9,spellPower:5,crit:8,upgradeData:{attack:5,critDamage:25}}),shortsword:new WeaponDef({displayName:"Shortsword",type:"sword",scalingBase:{strength:30,dexterity:40},buyCost:5e3,damage:11,spellPower:5,crit:5,upgradeData:{attack:8,crit:10}}),longsword:new WeaponDef({displayName:"Longsword",type:"sword",scalingBase:{strength:45,dexterity:25},buyCost:25e3,damage:13,spellPower:5,crit:5,upgradeData:{attack:10,critDamage:10}}),rapier:new WeaponDef({displayName:"Rapier",type:"sword",scalingBase:{dexterity:60},buyCost:25e3,damage:13,spellPower:5,crit:6.5,upgradeData:{crit:12,defense:10}}),greatsword:new WeaponDef({displayName:"Greatsword",type:"sword2h",scalingBase:{strength:70},buyCost:65e3,damage:16,spellPower:5,crit:3,upgradeData:{attack:15}}),greatersword:new WeaponDef({displayName:"Greatersword",type:"sword2h",scalingBase:{strength:75,dexterity:8},buyCost:25e4,researchCost:1500,damage:17,spellPower:5,crit:5,upgradeData:{attack:16,defense:2},prereqs:{buildings:{"research-center":1}}}),shamshir:new WeaponDef({displayName:"Shamshir",type:"sword",scalingBase:{dexterity:85},buyCost:5e5,researchCost:1500,damage:15,spellPower:5,crit:6,upgradeData:{attack:8,crit:8,critDamage:10},prereqs:{buildings:{"research-center":1}}}),axe:new WeaponDef({displayName:"Axe",type:"axe",scalingBase:{strength:80},buyCost:25e5,researchCost:7500,damage:19,spellPower:3,crit:5,upgradeData:{attack:7,maxDamage:10,critDamage:10},prereqs:{buildings:{"training-hall":1}}}),"rune-dagger":new WeaponDef({displayName:"Rune Dagger",type:"dagger",scalingBase:{dexterity:60,intelligence:30},buyCost:25e4,researchCost:5e3,damage:10,spellPower:12,crit:7,upgradeData:{crit:8,manaRegen:12},prereqs:{buildings:{"wizard-tower":1}}}),wand:new WeaponDef({displayName:"Wand",type:"wand",scalingBase:{dexterity:25,intelligence:65},buyCost:75e4,researchCost:5e3,damage:7,spellPower:15,crit:3,upgradeData:{spellPower:12,manaRegen:7},prereqs:{buildings:{"wizard-tower":1}}}),staff:new WeaponDef({displayName:"Staff",type:"staff",scalingBase:{strength:35,intelligence:50,wisdom:30},buyCost:15e5,researchCost:12500,damage:10,spellPower:18,crit:3,upgradeData:{spellPower:10,maxMana:8},prereqs:{buildings:{"wizard-tower":1}}}),scepter:new WeaponDef({displayName:"Scepter",type:"mace",scalingBase:{strength:60,wisdom:60},buyCost:25e5,researchCost:2e4,damage:15,spellPower:15,crit:5,upgradeData:{damage:10,manaRegen:10},prereqs:{buildings:{"wizard-tower":1}}}),"spark-wand":new WeaponDef({displayName:"Lightning Rod",type:"wand",scalingBase:{dexterity:65,intelligence:70},buyCost:1e7,damage:7,spellPower:20,crit:7,upgradeData:{spellPower:14,crit:5,critDamage:5},prereqs:{adventures:["sid3"]}})};return foreach(a,function(a,b){a.name=b}),a}function EnemyDef(a){this.name=a.name||"Enemy",this.displayName=a.displayName||"Enemy",this.image=a.image||"img/Shroomie.png",this.boss=a.boss||!1,this.minLevel=a.minLevel||0,this.health=a.health||10,this.attack=a.attack||5,this.reward=a.reward||{}}function EnemyContainer(a){this.index=a,this.level=0,this.def=null,this.health=0,this.maxHealth=0,this.attack=0,this.x=0,this.y=0,this.getHtml=function(){return'<div class="enemy-container" index='+this.index+'><div class="name"></div><div class="health-background"><div class="health-foreground enemy-health-'+this.index+'"></div></div><div><img class="enemy" draggable="false" index="'+this.index+'" /></div></div>'},this.selector=null,this.getSelector=function(){return this.selector||(this.selector=j(".enemy-container[index="+this.index+"]")),this.selector},this.imgSelector=null,this.getImgSelector=function(){return this.imgSelector||(this.imgSelector=this.getSelector().find(".enemy")),this.imgSelector},this.isActive=function(){return EnemyManager.activeEnemies.indexOf(this)>=0};var b=function(){var a={xp:function(a,b){return a*Math.pow(b,2)},gold:function(a,b){return rand(.35,1)*a*Math.pow(b,2)},research:function(a,b){return a*Math.pow(b,.85)},iron:function(a,b){return a*Math.pow(b,1.4)},wood:function(a,b){return a*Math.pow(b,1.15)}};return function(b,c){var d={},e=.3*c;for(var f in b)Player[f]&&Player[f].unlocked&&(d[f]=f in a?Math.ceil(a[f](b[f],e)):Math.ceil(b[f]*e));return Player.skill.unlocked&&(d.skill=5+Math.floor(Math.pow(c,.65))),d}}();this.respawn=function(a){this.level=EnemyManager.curArea.getRandomLevel(EnemyManager.subArea);var b=this.level/3;this.def=a,this.maxHealth=Math.floor(a.health*(1+.5*b+.03*Math.pow(b,2.7))),this.health=this.maxHealth,this.attack=Math.floor(a.attack*(1+.35*b+.15*Math.pow(b,1.9)));var c=this.getSelector(),d=this.getImgSelector();d.attr("src",a.image).toggleClass("boss",a.boss),c.find(".name").text("L"+this.level+" "+a.displayName);var e=d.width(),f=e,g=j(".spawn-area"),h=g.width(),i=g.height();this.x=rand(0,h-e)/h,this.y=rand(0,i-f)/i,this.getSelector().css({left:100*this.x+"%",top:100*this.y+"%"}),this.updateHealthBar(),this.clearPosCache()},this.clearPosCache=function(){this.cachedRelPos=null,this.cachedAbsPos=null},this.getRelativePosition=function(){if(!this.cachedRelPos){var a=j(".spawn-area"),b=this.getImgSelector(),c=b.position();this.cachedRelPos={x:a.width()*this.x+c.left,y:a.height()*this.y+c.top,w:b.width(),h:b.height()}}return shallowClone(this.cachedRelPos)},this.getAbsolutePosition=function(){if(!this.cachedAbsPos){var a=EnemyManager.jqAdventure.position();a.top=64;var b=j(".spawn-area").position(),c=this.getRelativePosition();this.cachedAbsPos={x:a.left+b.left+c.x,y:a.top+b.top+c.y,w:c.w,h:c.h}}return shallowClone(this.cachedAbsPos)},this.attackPower=function(){return this.attack},this.onClick=function(){Player.tryAttack(this)},this.takeDamage=function(a){this.health-=a.damage;var b=formatNumber(a.damage);a.isCrit?this.showMessage(b+"!",critParticleType):this.showMessage(b,damageParticleType);var c=this.getImgSelector();this.health<=0?(this.giveRewards(),c.toggleClass("blur",!1),EnemyManager.despawnEnemy(this)):(this.animateHealthBar(),Options.fancyGraphics&&c.toggleClass("blur",!0).one("transitionend",function(){c.toggleClass("blur",!1)}))},this.showMessage=function(a,b){b||(b=damageParticleType);var c=this.getAbsolutePosition(),d=c.x+randInt(-40,40)+c.w/2,e=c.y-64+randInt(-20,20)+c.h/2;ParticleContainer.create(b,a,d,e)},this.getHealthPercent=function(){return 100*clamp(this.health/this.maxHealth,0,1)},this.animateHealthBar=function(){var a=j(".enemy-health-"+this.index)[0].style,b=this;TimerManager.create(function(){var c=a.width.split("%")[0]/1,d=b.getHealthPercent();return function(b){a.width=lerp(b,c,d)+"%"}}(),125)},this.updateHealthBar=function(){j(".enemy-health-"+this.index).stop(!0,!0).css("width",this.getHealthPercent()+"%")},this.giveRewards=function(){var a=b(this.def.reward,this.level);for(var c in a)a[c]=Math.floor(Buffs.getMult(c+"Income")*a[c]);Player.giveResources(a);for(var d="",e=0;e<Player.resources.length;e++){var f=Player.resources[e],g=a[f];g>0&&Options.showRewards[f]&&(d+='<span class="'+f+'-reward">'+getIconHtml(f)+" "+formatNumber(g)+"</span><br>")}var h=this.getAbsolutePosition();ParticleContainer.create(rewardParticleType,d,h.x,h.y)},this.handleResize=function(){this.clearPosCache()}}function ItemDef(a){this.toSave=["count","isResearched"],this.name=a.name||"",this.displayName=a.displayName||a.name||"",this.description=a.description||"",this.onUse=a.onUse||null,this.isCountLimited=void 0!==a.isCountLimited?a.isCountLimited:!1,this.maxPerInvSlot=a.maxPerInvSlot||1,this.storeName=a.storeName||a.displayName||a.name||"",this.baseCost=a.baseCost||100,this.currency=a.currency||"gold",this.researchCost=a.researchCost||0,this.prereqs=a.prereqs||null,this.count=a.count||0,this.isResearched=this.researchCost<=0||!1,this.isConsumed=!0,this.getButtonHtml=function(){return getButtonHtml("Inventory.useItem('"+this.name+"')","<b>"+this.displayName+'</b>: <span id="count"></span>'+(void 0!==this.curCount?' / <span id="max-count"></span>':""),this.name+"-inv-button")},this.getStoreButtonHtml=function(){return'<div class="store-item" id="'+this.name+'">'+getButtonHtml("Inventory.tryPurchase('"+this.name+"')",'<b id="name"></b><br><span id="cost"></span> <span id="currency"></span>',"button")+' <span class="description"></span></div>'},this.updateButtons=function(){var a="#"+this.name+"-inv-button",b=this.isVisible();j(a,"toggle",b),b&&(j(a+" #count","text",formatNumber(this.getCount())),j(a+" #max-count","text",formatNumber(this.maxItemCount())));var c=".store-item#"+this.name+" #button",d=this.isVisibleInStore();if(j(".store-item#"+this.name,"toggle",d),d){var e="button "+this.getCurrency();this.canMakeMore()||(e+=" inactive"),j(c,"attr","class",e),j(c+" #name","html",this.isResearched?this.storeName:"Research "+this.storeName),j(c+" span #cost","text",formatNumber(this.getCost())),j(c+" span #currency","html",getIconHtml(this.getCurrency())),j(".store-item#"+this.name+" .description","html",this.isResearched?this.description:"")}},this.maxItemCount=function(){return this.maxPerInvSlot*Inventory.slotsPerItem},this.isItemMaxed=function(){return this.isCountLimited&&this.count>=this.maxItemCount()},this.isVisible=function(){return null!==this.onUse&&this.count>0},this.isVisibleInStore=function(){return prereqsMet(this.prereqs)&&(this.isResearched||canResearch())},this.update=a.update||function(){},this.tryPurchase=function(){if(this.canMakeMore()){var a=this;Player.spend(this.getCurrency(),this.getCost(),function(){a.onPurchase(),Inventory.updateButtons()})}},this.onPurchase=function(){this.isResearched?(this.count+=1,void 0!==this.curCount&&(this.curCount+=1)):this.isResearched=!0,this.update()},this.getCost=function(a,b){var c=b&&b.bind(a);return function(){return this.isResearched?c?c():this.baseCost:this.researchCost}}(this,a.getCost),this.getCurrency=function(){return this.isResearched?this.currency:"research"},this.canAfford=function(){return this.getCost()<=Player[this.getCurrency()].amount},this.isLimitReached=a.isLimitReached||function(){return this.isItemMaxed()},this.canMakeMore=function(){return!AdventureScreen.isAdventuring()&&this.canAfford()&&!this.isLimitReached()},this.canUse=function(){return this.count>0&&this.onUse},this.getCount=function(){return this.count}}function PotionDef(a){this.__proto__=new ItemDef(a),this.toSave.push("curCount"),this.isConsumed=!1,this.healAmount=a.healAmount||0,this.manaAmount=a.manaAmount||0,this.curCount=a.curCount||0,this.onUse=function(){var a=Skills.getPassiveMult("itemEffeciency"),b=Math.floor(a*this.healAmount),c=Math.floor(a*this.manaAmount);Player.addHealth(b),Player.addMana(c),this.curCount--},this.getCost=function(){return this.isResearched?this.baseCost*Math.pow(3,this.count):this.researchCost},this.description="Restores",this.healAmount&&(this.description+=" "+formatNumber(this.healAmount)+"HP"),this.manaAmount&&(this.description+=" "+formatNumber(this.manaAmount)+"MP"),this.canUse=function(){return this.curCount>0},this.getCount=function(){return this.curCount},this.maxItemCount=function(){return this.count}}function ParticleType(a){this.className=a.className||"",this.animHeight=a.animHeight||100,this.animTime=a.animTime||500}function StatType(a){this.toSave=["level","unlocked"],this.name=a.name||"",this.displayName=a.displayName||this.name||"",this.abbrev=a.abbrev||this.displayName||"",this.description=a.description||"",this.prereqs=a.prereqs||null,this.baseValue=a.baseValue||0,this.levelValue=a.levelValue||1,this.isPercent=a.isPercent||!1,this.stringPostfix=a.stringPostfix||"",this.bonus=a.bonus||0,this.level=0,this.unlocked=!1,this.value=function(){var a=this.getBaseValue();
return this.isPercent&&(a*=.01),a},this.getBaseValue=function(){return this.getBaseValueAtLevel(this.level)},this.getBaseValueAtLevel=a.getBaseValueAtLevel||function(a){return this.baseValue+a*this.levelValue},this.getBonusMult=function(){return 1+this.getTotalBonus()/100},this.getTotalBonus=function(){return this.value()*this.bonus},this.getStringPostfix=function(){return this.stringPostfix||(this.isPercent?"%":"")},this.stringValue=function(){return formatNumber(this.getBaseValue())+this.getStringPostfix()},this.upgradeCost=function(){return Math.ceil(10+5*this.level+.2*Math.pow(this.level,3.2))+Player.statUpgradeBaseCost()},this.upgradeValue=function(){return this.getBaseValueAtLevel(this.level+1)-this.getBaseValueAtLevel(this.level)},this.stringUpgradeValue=function(){return formatNumber(this.upgradeValue())+this.getStringPostfix()},this.canUpgrade=function(){return this.isUnlocked()&&Player.xp.amount>=this.upgradeCost()},this.tryUpgrade=function(){return this.canUpgrade()?(Player.xp.amount-=this.upgradeCost(),this.level++,this.onUpgrade(),Player.updateStatButtons(),!0):!1},this.isUnlocked=function(){return this.unlocked||(this.unlocked=prereqsMet(this.prereqs)),this.unlocked},this.getUpgradeButtonHtml=function(){var a=this.displayName+': <span id="amount"></span><br/><span id="upgrade">(+<span id="upgrade-amount"></span>) : <span id="cost"></span> '+getIconHtml("xp")+"</span>";return getButtonHtml("Player.upgrade('"+this.name+"')",a,"stat-"+this.name+"-button","xp")},this.updateButton=function(){var a="#stat-"+this.name+"-button";j(a,"toggle",this.isUnlocked()),j(a,"toggleClass","inactive",!this.canUpgrade()),j(a+" #amount","text",this.stringValue()),j(a+" #upgrade-amount","text",this.stringUpgradeValue()),j(a+" #cost","text",formatNumber(this.upgradeCost()));var b=this.description,c={bonus:this.bonus,totalBonus:this.getTotalBonus()};for(var d in c)for(var e="<"+d+">";-1!=b.indexOf(e);){var f='<span class="statDesc-'+d+'">'+formatNumber(c[d])+"</span>";b=b.replace(e,f)}j(a+" .description","html",b)},this.onUpgrade=a.onUpgrade||function(){}}function prereqsMet(a){var b;if(!a)return!0;if(a.playerLevel&&Player.getLevel()<a.playerLevel)return!1;if(a.items)for(b=0;b<a.items.length;b++)if(!Inventory.getItem(a.items[b]).isResearched)return!1;if(a.adventures)for(b=0;b<a.adventures.length;b++)if(!AdventureScreen.hasBeat(a.adventures[b]))return!1;if(a.buildings)for(b in a.buildings){var c=Village.buildings[b];if(c&&(!c.isResearched||c.count<a.buildings[b]))return!1}if(a.upgrades)for(b in a.upgrades){var d=Village.upgrades[b];if(d&&(!d.isResearched||d.count<a.upgrades[b]))return!1}return!0}function canResearch(){return prereqsMet({buildings:{"research-center":1}})}function AdventureDef(a){this.toSave=["beatOnPower","power"],this.prereqs=a.prereqs||null,this.name=a.name||"",this.category=a.category||"",this.displayName=a.displayName||"",this.areaType=a.areaType||"grass",this.subAreas=a.subAreas||[{level:2,levelRand:1,spawnLo:3,spawnHi:5,useAll:!0,enemies:{enemy:100}}],this.allEnemies=a.allEnemies||{},this.allLevelRand=a.allLevelRand||0,this.spawnCountLo=a.spawnCountLo||3,this.spawnCountHi=a.spawnCountHi||5,this.clearMessage=a.clearMessage||"",this.beatOnPower=-1,this.power=0;var b=20;this.postLoad=function(){this.power=Math.min(this.power,b),this.canSeeInShrine()||(this.power=0)},this.update=function(){var a="#"+this.name+"-button",b="#"+this.name+"-power";j(a,"toggle",this.isAvailable()),j(b,"toggle",this.isAvailable()),this.isAvailable()&&(j(a,"toggleClass","selected",this.power<=this.beatOnPower),j(b+"-count","text",formatNumber(this.getMaxLevel())),j(b+"-dec","toggle",this.power>0),j(b+"-inc","toggle",this.canIncreasePower()),j(b+"-inc-cost","text",formatNumber(this.powerUpCost())))},this.isAvailable=function(){return prereqsMet(this.prereqs)},this.canIncreasePower=function(){return this.power<=this.beatOnPower&&this.power<b},this.subUseAll=function(a){var b=this.subAreas[a];return void 0===b.useAll||b.useAll},this.getLevelHi=function(a){var b=this.subAreas[a],c=(this.subUseAll(a)?this.allLevelrand:b.levelRand)||0;return b.level+c},this.getRandomLevel=function(a){var b=this.subAreas[a],c=this.getBaseMaxLevel()-randIntInc(b.level,this.getLevelHi(a));return this.getMaxLevel()-c},this.getRandomEnemy=function(a){var b=[],c=[],d=0,e=this.subAreas[a];this.subUseAll(a)&&foreach(this.allEnemies,function(a,e){b.push(e),c.push(a),d+=a}),foreach(e.enemies,function(a,e){b.push(e),c.push(a),d+=a});for(var f=rand(0,d),g=0;g<b.length&&f>c[g];)f-=c[g],g++;return b[g]},this.getRandomSpawnCount=function(a){var b=this.subAreas[a];return this.subUseAll(a)||!b.spawnLo?randIntInc(this.spawnCountLo,this.spawnCountHi):randIntInc(b.spawnLo,b.spawnHi)},this.getBaseMaxLevel=function(){for(var a=0,b=0;b<this.subAreas.length;b++)a=Math.max(a,this.getLevelHi(b));return a},this.getMaxLevel=function(){return Math.ceil(this.getBaseMaxLevel()*Math.pow(1.2,this.power))},this.powerUpCost=function(){return 500*(this.power+1)},this.canSeeInShrine=function(){return"Main"==this.category||"OSTM"==this.category},this.onClear=function(){this.clearMessage&&this.beatOnPower<0&&Log.write(this.clearMessage),this.beatOnPower=Math.max(this.power,this.beatOnPower)}}function mapSelectHtml(){var a="";return foreach(AdventureScreen.screens,function(b){"field"!=b.name&&"map-select"!=b.name&&(a+=getButtonHtml("AdventureScreen.setScreen('"+b.name+"')",b.displayName,b.name+"-button")+" ")}),a+="<br>",foreach(AdventureScreen.categorizedAdventures,function(b,c){a+='<div class="category cat-'+c+'"><h3>'+c+"</h3>",foreach(b,function(b){a+=getButtonHtml("AdventureScreen.startAdventure('"+b.name+"')",b.displayName,b.name+"-button")+" "}),a+="</div>"}),a}function shrineHtml(){var a=getButtonHtml("AdventureScreen.setScreen('map-select')","Leave");for(var b in AdventureScreen.adventures){var c=AdventureScreen.adventures[b];if(c.canSeeInShrine()){var d=c.name+"-power";a+='<div id="'+d+'">'+getButtonHtml("AdventureScreen.decreasePower('"+c.name+"')","Decrease Power",d+"-dec")+" <span>"+c.displayName+' : Max enemy Level <span id="'+d+'-count"></span></span> '+getButtonHtml("AdventureScreen.increasePower('"+c.name+"')",'Increase Power<br><span id="'+d+'-inc-cost"></span>'+getIconHtml("research"),d+"-inc","research")+"</div>"}}return a}function WeaponDef(a){this.toSave=["owned","researched","level","ascensions"],this.name=a.name||"",this.displayName=a.displayName||"",this.scalingBase=a.scalingBase||{strength:50},this.damage=a.damage||2,this.crit=a.crit||5,this.spellPower=a.spellPower||0,this.ascendDamage=a.ascendDamage||1,this.ascendSpellPower=a.ascendSpellPower||1,this.buyCost=a.buyCost||1e3,this.researchCost=a.researchCost||0,this.upgradeCost=5e3*(a.upgradeCostMult||1),this.upgradeData=a.upgradeData||{damage:10},this.ascendCost=500*(a.ascendCostMult||1),this.prereqs=a.prereqs||null,this.owned=a.owned||!1,this.researched=this.owned||this.researchCost<=0,this.level=0,this.ascensions=0,this.type=Mastery.weaponTypes[a.type],this.getName=function(){return this.ascensions>0?this.displayName+" +"+this.ascensions:this.displayName},this.getFlatUpgradeAmount=function(a){return this.getBaseUpgradeAmount(a)+this.type.getUpgradeAmount(a)},this.getBaseUpgradeAmount=function(a){var b=this.upgradeData[a];return b?(1+this.level/2)*b:0},this.getMult=function(a){return(1+this.getBaseUpgradeAmount(a)/100)*(1+this.type.getUpgradeAmount(a)/100)},this.getBaseDamage=function(){return this.damage+this.ascensions*this.ascendDamage},this.getBaseSpellPower=function(){return this.spellPower?this.spellPower+this.ascensions*this.ascendSpellPower:0},this.getTotalUpgradeCount=function(){return this.level+(this.ascensions+5)*(this.ascensions+4)/2-10},this.getScaling=function(a){return this.scalingBase[a]?this.scalingBase[a]*(1+this.getTotalUpgradeCount()/100):0},this.getTotalScalingOfType=function(a){var b=1,c=this;return foreach(this.scalingBase,function(d,e){Player[e]&&getStatClass(e)===a&&(b+=Player[e].value()*c.getScaling(e)/100)}),b},this.getDamage=function(){return this.getMult("attack")*this.getTotalScalingOfType("physical")*this.getBaseDamage()},this.getSpellPower=function(){return this.getMult("spellPower")*this.getTotalScalingOfType("mental")*this.getBaseSpellPower()},this.getBaseCrit=function(){return this.crit},this.getMaxLevel=function(){return 4+this.ascensions},this.isMaxLevel=function(){return this.level>=this.getMaxLevel()},this.getCost=function(){return this.researched?this.owned?this.isMaxLevel()?Math.floor(this.ascendCost*Math.pow(this.ascensions+1,3)):Math.floor(this.upgradeCost*Math.pow(this.level+1,1.6+.1*this.ascensions)*(.2*this.ascensions+1)):this.buyCost:this.researchCost},this.getCurrency=function(){return this.researched?this.owned&&this.isMaxLevel()?"iron":"gold":"research"},this.canPurchase=function(){return Player.canSpend(this.getCurrency(),this.getCost())},this.purchase=function(){this.researched?this.owned?this.isMaxLevel()?(this.ascensions+=1,this.level=0):this.level+=1:this.owned=!0:this.researched=!0},this.getButtonHtml=function(){return'<div class="weapon-container" id="'+this.name+'"><span id="name"></span>'+getButtonHtml("Blacksmith.equip('"+this.name+"')","Equip","equip")+" "+getButtonHtml("Blacksmith.tryPurchase('"+this.name+"')",'<span id="action"></span><br><span id="cost"></span>',"button")+'<div id="description"><span id="scaling"></span><span id="base"></span><span id="upgrades"></span></div></div>'},this.updateButton=function(){var a=".weapon-container#"+this.name,b=this.owned||prereqsMet(this.prereqs);if(j(a,"toggle",b),b){var c=this.name==Player.weaponName;j(a+" #equip","toggle",this.owned),j(a+" #equip","toggleClass","selected",c);var d=null;this.isMaxLevel()?d={buildings:{forge:1}}:this.owned&&(d={buildings:{anvil:1}}),j(a+" #button","toggle",prereqsMet(d));var e="button "+this.getCurrency();this.canPurchase()||(e+=" inactive"),j(a+" #button","attr","class",e);var f="Buy";this.isMaxLevel()?f="Ascend":this.owned?f="Upgrade":this.researched||(f="Research"),j(a+" #action","text",f);var g=this.getName();this.level>0&&(g+=" ("+this.level+"/"+this.getMaxLevel()+")"),j(a+" #name","text",g),j(a+" #cost","html",formatNumber(this.getCost())+" "+getIconHtml(this.getCurrency())),j(a+" #description","toggle",this.researched);for(var h="<ul>",i=0;i<Player.stats.length;i++){var k=Player.stats[i],l=Player[k],m=this.getScaling(k);l&&m&&(h+='<li class="'+getStatClass(k)+'">'+l.abbrev+": "+formatNumber(m,1)+"%</li>")}h+="</ul>",j(a+" #scaling","html",h);var n="<ul><li>Type: "+this.type.displayName+'</li><li class="physical">Attack: '+formatNumber(this.getBaseDamage())+'<li class="mental">Spell: '+formatNumber(this.getBaseSpellPower())+"</li></li><li>Base Crit: "+formatNumber(this.crit)+"%</li>";n+="</ul>",j(a+" #base","html",n);var o="<ul>";for(var p in this.upgradeData)o+="<li>"+getUpgradeName(p)+": +"+formatNumber(this.getBaseUpgradeAmount(p))+"%</li>";o+="</ul>",j(a+" #upgrades","html",o)}}}function BuffDef(a){this.toSave=["secondsLeft","level","secondsActivated"],this.name=a.name||"",this.displayName=a.displayName||"",this.effects=a.effects||{},this.secondsLeft=0,this.level=1,this.secondsActivated=0,this.activatedPartial=0,this.getButtonHtml=function(){return'<div class="buff-container" id="'+this.name+'"><b>'+this.displayName+"</b> "+getButtonHtml("Buffs.activateBuff('"+this.name+"')","+10 Minutes<br>1,000 "+getIconHtml("research"),"button","research")+'<div id="buff-desc"><ul><li id="level"></li><li id="effect"></li><li id="xpBar"><span id="xpBar-foreground"></span><span id="xpBar-text"></span></li><li id="timeleft"></li></ul></div></div>'},this.update=function(){if(this.isActivated()){this.activatedPartial+=Game.dT;var a=Math.floor(this.activatedPartial);this.activatedPartial-=a,this.secondsActivated+=a,this.secondsActivated>=this.toNextLevel()&&(this.secondsActivated-=this.toNextLevel(),this.level++,Player.refreshResourceProduction()),this.secondsLeft-=a,this.secondsLeft<=0&&(this.secondsLeft=0,Player.refreshResourceProduction())}this.updateButton()},this.updateButton=function(){var a=".buff-container#"+this.name;j(a+" #level","text","Level: "+this.level),j(a+" #button","toggleClass","inactive",!Player.canSpend("research",1e3)),j(a+" #xpBar-text","text","Next Level: "+formatTime(this.toNextLevel()-this.secondsActivated)),j(a+" #xpBar-foreground","toggleClass","selected",this.isActivated()),j(a+" #xpBar-foreground","css","width",100*(this.secondsActivated/this.toNextLevel())+"%");var b="";this.secondsLeft>0&&(b="Time Left: "+formatTime(this.secondsLeft)),j(a+" #timeleft","text",b);var c="";for(var d in this.effects)c+=getUpgradeName(d)+": +"+this.getBonus(d)+"%";j(a+" #effect","text",c)},this.activate=function(){Player.spend("research",1e3)&&(this.secondsLeft+=600,Player.refreshResourceProduction())},this.isActivated=function(){return this.secondsLeft>0},this.getBonus=function(a){var b=this.effects[a];return b?b.base+(this.level-1)*b.level:0},this.toNextLevel=function(){return 150*this.level*(this.level+1)}}function WeaponTypeDef(a){this.toSave=["xp","level"],this.name=a.name||"",this.displayName=a.displayName||"",this.upgradeData=merge(a.upgradeData||{},{crit:2}),this.level=0,this.xp=0,this.addXp=function(a){for(this.xp+=a;this.xp>=this.getNextLevelXp();)this.xp-=this.getNextLevelXp(),this.level++},this.getNextLevelXp=function(){return this.getLevelXp(this.level)},this.getLevelXp=function(a){return 500*a*(1+a)+1e4},this.getUpgradeAmount=function(a){var b=this.upgradeData[a];return b?(1+this.level)*b:0},this.getButtonHtml=function(){return'<div class="mastery-container" id="'+this.name+'"><div><span id="name">'+this.displayName+'</span> <span id="mastery-level"></span><div id="upgrades"></div></div><div id="xpBar"><span id="xpBar-foreground"></span><span id="xpBar-text"></span></div></div>'},this.updateButton=function(){var a=".mastery-container#"+this.name;j(a+" #mastery-level","text","L: "+this.level);var b="<ul>";for(var c in this.upgradeData)b+="<li>"+getUpgradeName(c)+": +"+formatNumber(this.getUpgradeAmount(c))+"%</li>";b+="</ul>",j(a+" #upgrades","html",b),j(a+" #xpBar-text","text",formatNumber(this.xp)+" / "+formatNumber(this.getNextLevelXp())),j(a+" #xpBar-foreground","toggleClass","selected",Player.weapon.type===this),j(a+" #xpBar-foreground","width",100*this.xp/this.getNextLevelXp()+"%")}}function ScreenDef(a){this.name=a.name||"",this.displayName=a.displayName||a.name||"",this.html=a.html||"",this.createHtml=a.createHtml||function(){return this.html},this.adventuresBlock=a.adventuresBlock||!1,this.prereqs=a.prereqs||null,this.hidden=a.hidden||!1}function ScreenContainer(a){this.screens=a.screens||[],this.classBase=a.classBase||"screen",this.targetDiv=a.targetDiv||".main-area",this.curScreen="",this.init=function(){this.preInit();for(var a="",b=0;b<this.screens.length;b++){var c=this.screens[b];a+='<div class="'+this.classBase+" "+c.name+'">'+c.createHtml()+"</div>"}$(this.targetDiv).html(a),this.postInit(),this.screens.length>0&&this.setScreen(this.screens[0].name)},this.preInit=a.preInit||function(){},this.postInit=a.postInit||function(){},this.update=a.update||function(){},this.getScreen=function(a){for(var b=0;b<this.screens.length;b++){var c=this.screens[b];if(c.name===a)return c}return null},this.setScreen=function(a){j("#"+a+"-button").hasClass("inactive")||(j("."+this.classBase).hide(),j("."+a).show(),this.onScreenSet(a),this.curScreen=a)},this.updateScreens=function(){foreach(this.screens,function(a){var b="#"+a.name+"-button";j(b,"toggle",prereqsMet(a.prereqs)),j(b,"toggleClass","inactive",a.adventuresBlock&&AdventureScreen.isAdventuring())})},this.onScreenSet=a.onScreenSet||function(){},this.isOpen=function(a){return this.curScreen==a}}function getChangelistHtml(){var a="<div>NOTE: <i>This game is very much pre-alpha. Expect bugs, wild balance changes, missing content, and other insanities.</i></div>";for(var b in changelist){var c=changelist[b];a+="<h3>"+b+" - ",c.date&&(a+="<i>"+c.date+"</i> - "),a+=c.description+"</h3><div><ul>";for(var d=0;d<c.changes.length;d++)a+="<li>"+c.changes[d]+"</li>";a+="</ul></div>"}return a}function SkillDef(a){this.toSave=["researched","level"],this.name=a.name||"",this.category=a.category||"",this.displayName=a.displayName||"",this.description=a.description||"",this.researchCost=a.researchCost||0,this.baseCost=a.baseCost||1e3,this.upgradeCost=35*(a.upgradeCostMult||1),this.prereqs=a.prereqs||null,this.level=a.level||0,this.researched=this.level>0||this.researchCost<=0,this.getCost=function(){return this.researched?Math.floor(this.baseCost+this.upgradeCost*Math.pow(this.level,2)):this.researchCost},this.getCurrency=function(){return this.researched?"skill":"research"},this.canPurchase=function(){return Player.canSpend(this.getCurrency(),this.getCost())},this.purchase=function(){this.researched?this.level+=1:this.researched=!0},this.isAttack=function(){return"Attack"===this.category||"Spell"===this.category},this.getButtonHtml=function(){return'<div class="skill-container" id="'+this.name+'"><span id="name"></span>'+getButtonHtml("Skills.tryPurchase('"+this.name+"')",'<span id="action"></span><span id="level"></span><br><span id="cost"></span>',"button","skill")+'<div id="description"></div></div>'},this.getAttackButtonHtml=function(){var a=this.keyCode?" ("+this.keyCode.toUpperCase()+")":"";return getButtonHtml("Skills.equip('"+this.name+"')",this.displayName+a+'<br><span id="mana"></span>',this.name+"-equip")},this.updateButton=function(){var a=".skill-container#"+this.name,b="#"+this.name+"-equip",c=this.level>0,d=this.isKnown||prereqsMet(this.prereqs);if(j(a,"toggle",d),j(b,"toggle",c),c){var e=this.name===Player.attackName;j(b,"toggleClass","selected",e);var f="";this.manaCost&&this.getManaCost()>0&&(f=formatNumber(this.getManaCost())+" MP"),j(b+" #mana","text",f)}if(d){j(a+" #button","toggleClass","inactive",!this.canPurchase()),j(a+" #name","text",this.displayName);var g="Level";this.researched?0===this.level&&(g="Learn"):g="Research",j(a+" #action","text",g);var h="";this.level>0&&(h=" (L"+formatNumber(this.level)+")"),j(a+" #level","text",h),j(a+" #cost","html",formatNumber(this.getCost())+" "+getIconHtml(this.getCurrency())),j(a+" #description","toggle",this.researched),j(a+" #description","html",this.getDescription())}},this.getDescriptionAtLevel=function(a){return this.displayName+" Level "+a},this.getLevelDescription=function(){return this.level<1?this.getDescriptionAtLevel(1):this.getDescriptionAtLevel(this.level)+" --> "+this.getDescriptionAtLevel(this.level+1)},this.getDescription=this.getLevelDescription}function AttackSkillDef(a){this.__proto__=new SkillDef(a),this.category="Attack",this.keyCode=a.keyCode||null,this.manaCost=a.manaCost||0,this.baseDamage=a.baseDamage||100,this.levelDamage=a.levelDamage||10,this.baseCrit=a.baseCrit||0,this.bonuses=a.bonuses||{},this.getDamage=function(){return this.getDamageAtLevel(this.level)},this.getDamageAtLevel=function(a){return this.baseDamage+this.levelDamage*(a-1)},this.getBonusMult=function(a){return this.bonuses[a]?1+this.bonuses[a]/100:1},this.getManaCost=function(){return this.getManaCostAtLevel(this.level)},this.getManaCostAtLevel=function(a){return this.manaCost?Math.floor(this.manaCost*(1+.1*(a-1))):0},this.getBaseCrit=function(){return this.baseCrit},this.getDescriptionAtLevel=function(a){var b='<div id="base"><ul><li>Damage: '+formatNumber(this.getDamageAtLevel(a))+"</li>";return this.getBaseCrit()&&(b+="<li>Crit Chance: "+formatNumber(this.getBaseCrit())+"%</li>"),this.getManaCostAtLevel(a)&&(b+="<li>Mana Cost:"+formatNumber(this.getManaCostAtLevel(a))+"</li>"),b+="</ul></div>"},this.getDescription=function(){return"<div>"+this.description+"</div><div>"+this.getLevelDescription()+"</div>"},this.doAttack=a.doAttack||function(a){a.takeDamage(Player.getDamageInfo())}}function SpellSkillDef(a){a.prereqs=merge(a.prereqs,{buildings:{"wizard-tower":1}}),this.__proto__=new AttackSkillDef(a),this.category="Spell"}function PassiveSkillDef(a){this.__proto__=new SkillDef(a),this.category="Passive";var b={};b.mult=a.statMult||{},b.base=a.statBase||{};var c=function(a,c,d){var e=b[a][c];if(!e||1>d)return 0;var f=e.base||0,g=e.level||0;return f+g*(d-1)};this.getMult=function(a){return 1+c("mult",a,this.level)/100},this.getBase=function(a){return c("base",a,this.level)},this.getDescriptionAtLevel=function(a){for(var d=this.description,e=["mult","base"],f=0;f<e.length;f++){var g=e[f];for(var h in b[g])for(var i="<"+g+"."+h+">";-1!=d.indexOf(i);){var j=formatNumber(c(g,h,a));d=d.replace(i,j)}}return d}}function BuildingDef(a){this.toSave=["count","isResearched"],this.name=a.name||"",this.displayName=a.displayName||"",this.description=a.description||"",this.baseCost=a.baseCost||1e4,this.costIncreasePercent=a.costIncreasePercent||10,this.researchCost=a.researchCost||0,this.prereqs=a.prereqs||null,this.maxCount=a.maxCount||0,this.resourceProduced=a.resourceProduced||"gold",this.resourcePerSecond=a.resourcePerSecond||0,this.count=0,this.isResearched=0===this.researchCost||!1,this.getButtonHtml=function(){return this.name+"-button",'<div id="'+this.name+'-building">'+getButtonHtml("Village.buyBuilding('"+this.name+"')",'<b id="name"></b><span id="count"></span><br><span id="cost"></span>',"button")+' <span id="description""></span></div>'},this.updateButton=function(){var a="#"+this.name+"-building";j(a,"toggle",this.isVisible()),j(a+" #name","text",this.isResearched?this.displayName:"Research "+this.displayName);var b="button "+this.getCurrency();this.canAfford()||(b+=" inactive"),j(a+" #button","attr","class",b),j(a+" #count","text",this.isResearched?": "+formatNumber(this.count):""),j(a+" #cost","html",formatNumber(this.getCost())+" "+getIconHtml(this.getCurrency())),j(a+" #description","html",this.isResearched?this.description?this.description:"+"+formatNumber(this.getProduction())+" "+getIconHtml(this.resourceProduced)+"/s":"")},this.isVisible=function(){return(this.isResearched||canResearch())&&prereqsMet(this.prereqs)&&(!this.maxCount||this.count<this.maxCount)},this.getCost=function(){return this.isResearched?Math.ceil(this.baseCost*Math.pow(1+this.costIncreasePercent/100,this.count)):this.researchCost},this.getCurrency=function(){return this.isResearched?"gold":"research"},this.canAfford=function(){return Player.canSpend(this.getCurrency(),this.getCost())},this.getProduction=function(){var a=this.resourcePerSecond,b=this.name;return foreach(Village.upgrades,function(c){c.count>0&&b==c.targetBuilding&&(a=c.apply(a))}),a}}function UpgradeDef(a){this.toSave=["count","isResearched"],this.name=a.name||"",this.displayName=a.displayName||"",this.description=a.description||"",this.baseCost=a.baseCost||1e4,this.costIncreasePercent=a.costIncreasePercent||15,this.researchCost=a.researchCost||0,this.prereqs=a.prereqs||null,this.maxCount=void 0!==a.maxCount?a.maxCount:1,this.targetBuilding=a.targetBuilding||"",this.amountIncrease=a.amountIncrease||0,this.count=0,this.isResearched=0===this.researchCost||!1,this.getButtonHtml=function(){return this.name+"-button",'<div id="'+this.name+'-building">'+getButtonHtml("Village.buyUpgrade('"+this.name+"')",'<b id="name"></b><br><span id="cost"></span>',"button")+' <span id="description""></span></div>'},this.updateButton=function(){var a="#"+this.name+"-building";j(a,"toggle",this.isVisible()),j(a+" #name","text",this.isResearched?this.displayName:"Research "+this.displayName);var b="button "+this.getCurrency();this.canAfford()||(b+=" inactive"),j(a+" #button","attr","class",b),j(a+" #cost","html",formatNumber(this.getCost())+" "+getIconHtml(this.getCurrency())),j(a+" #description","html",this.isResearched?this.description?this.description:Village.buildings[this.targetBuilding].displayName+" +"+formatNumber(this.amountIncrease)+"%":"")},this.isVisible=function(){return(this.isResearched||canResearch())&&Player.wood.unlocked&&prereqsMet(this.prereqs)&&(!this.maxCount||this.count<this.maxCount)},this.getCost=function(){return this.isResearched?Math.ceil(this.baseCost*Math.pow(1+this.costIncreasePercent/100,this.count)):this.researchCost},this.getCurrency=function(){return this.isResearched?"wood":"research"},this.canAfford=function(){return Player.canSpend(this.getCurrency(),this.getCost())},this.apply=a.apply||function(a){return(1+this.amountIncrease*this.count/100)*a}}function rand(a,b){return Math.random()*(b-a)+a}function randInt(a,b){return Math.floor(rand(a,b))}function randIntInc(a,b){return randInt(a,b+1)}function randItem(a){return a[randInt(0,a.length)]}function clamp(a,b,c){return Math.max(b,Math.min(c,a))}function clamp01(a){return clamp(a,0,1)}function lerp(a,b,c){return clamp01(a)*(c-b)+b}function distance(a,b,c,d){var e=c-a,f=d-b;return Math.sqrt(e*e+f*f)}function vecDistance(a,b){return distance(a.x,a.y,b.x,b.y)}function removeItem(a,b){var c=b.indexOf(a);return c>=0?(b.splice(c,1),!0):!1}function formatNumber(a,b){void 0===b&&(b=2);var c=a.toString().split(".");if(c[0]=c[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),c.length>1){var d=c[1];if(d.length>b)for(d=Math.round(c[1].slice(0,b+1)/10).toString();d.length<b;)d="0"+d;d=d.slice(0,b);for(var e=d.length-1;e>=0&&"0"===d[e];e--)d=d.slice(0,e);c[1]=d.length>0?"."+d:""}return c.join("")}function getButtonHtml(a,b,c,d){var e=c?' id="'+c+'"':"",f='class="button';return d&&(f+=" "+d),f+='"',"<div "+f+' onclick="'+a+'; hideButtonDescription(this)" onmouseover="showButtonDescription(this)" onmouseout="hideButtonDescription(this)"'+e+'><span class="content">'+b+'</span><div class="description" style="display:none"></div></div>'}function showButtonDescription(a){var b=$(a).find(".description");b.html()&&(j(".description-box").show().css({left:Game.mouse.x,top:Game.mouse.y}),j(".description-box","html",b.html()))}function hideButtonDescription(){j(".description-box").hide()}function foreach(a,b){for(var c in a)b(a[c],c)}function shallowClone(a){var b={};for(var c in a)b[c]=a[c];return b}function merge(a,b){var c=shallowClone(a);for(var d in b)void 0===c[d]&&(c[d]=b[d]);return c}var changelist={"v0.2.11":{description:"Witch",date:"Feb 16, 2014",changes:["Enable limited-time buffs at the Witch's Cave","Enemies no longer drop Research","Some research costs reduced","Some research costs not reduced! Further rebalancing coming soon","Fixed some weird behavior with the new crit system"]},"v0.2.10":{description:"Bugfix",date:"Feb 6, 2014",changes:["Updating from v0.2.8 or earlier no longer resets armor"]},"v0.2.9":{description:"Item/Crit Revamps",date:"Feb 6, 2014",changes:["Items are refilled on visiting the Inn, buy more capacity from the Store","Critical Hit Chance in excess of 100% deals bonus damage","On running out of mana, player can use basic attacks without deselecting previous skill"]},"v0.2.8":{description:"Side Areas",date:"Feb 1, 2014",changes:["Added optional areas","Some things unlock differently","Side areas have hidden secrets?!"]},"v0.2.7":{description:"We're Back",date:"Jan 26, 2014",changes:["Added Weapon Mastery","Decreased stat gain per weapon level, reduced gold cost per weapon level"]},"v0.2.6":{description:"New areas",changes:["Two new areas (woo)","Also I changed how areas are named for the future, please ignore slight wonkiness","Made Changelist link obvious, added link to OSTM subreddit"]},"v0.2.5":{description:"Skill/Stat restructuring",changes:["Skills no longer scale with stats(!!)","Some attack skills have extra modifications","Stats now have a secondary effect","Added in-game changelist (click the version number)","Added two weapons"]},"v0.2.4":{description:"Button Colors",changes:["Buttons that spend currency are now that currency's color","Normal Attack has a hotkey","Added Whirlwind skill, some upgrades","Added Privacy Policy for future reference"]},"v0.2.3":{description:"Spell Work",changes:["Spell Power from weapons scales with Int","Spells can Critically Strike","Skill rebalancing (mostly nerfs?)","Added two passive skills, one spell"]},"v0.2.2":{description:"Silly bugfix",changes:["You can now leave the Mortal Shrine!"]},"v0.2.1":{description:"Spam reduction",changes:["Reward messages can be toggled per-resource","Added a second Shrine"]},"v0.2.0":{description:"Content",changes:["New spells, weapons, enemies, buildings, upgrades","Select spells with keyboard shortcuts","More enemies give wood, Sand Sea has a boss","Some performance optimizations (because some new spells are CPU-intensive)"]},"v0.1.12":{description:"Small stuff",changes:["Don't increase mana cost for basic attack","Inn cost increases by 50% per use (down from 100%)","Add Health Mastery passive skill","Fix a bug where numbers like '0.06' could display as '0.6'"]},"v0.1.11":{description:"More Adventures",changes:["More Adventures","Return of the Inn; now with variable cost","Mana costs on Skills increase with skill level","Added Alchemy skill and Super Potions","Passive Skills have descriptions"]},"v0.1.10":{description:"Sorry 'bout the font",changes:["New font, but less drastically different, with no outlining","Except for on the healthbar where it makes it more readable"]},"v0.1.9":{description:"Upheaval",changes:["Made health scale linearly (without skills)","Made health regen not percentage-based (without skills)","Removed the Inn","Mana can now be upgraded directly","Visual tweaks","Some behavioral options (in the Options menu)"]},"v0.1.8":{description:"Fixes",changes:["Game runs smoothly when off-tab","Added a repeatable tent upgrade"]},"v0.1.6":{description:"Balancing",changes:["Higher level enemies are harder","XP costs / gains have been altered","Leveling up any stat increases defense slightly","Shrine scales enemy levels exponentially, so earlier areas can keep up","Shrine cost currently set to 0 for the hell of it (so I can get feedback on how enemies scale independent of the cost of it)"]},"v0.1.5":{description:"Balancing, Spells",changes:["Weapon scaling has been tweaked slightly (cheaper earlier, more expensive later)","Skill Points scaling has been tweaked a lot. Enemies give much less per level, but cost scales less aggressively","Spells and Spell Power have been added","Skills can scale their damage with stats","New skills and weapon"]},"v0.1.4":{description:"",changes:["Added Google Analytics for curiosity's sake","Changed how stats scale on weapons; hopefully it's more transparent","Change how upgrade/ascension costs scale. That's going to be balanced better in the near-future","Minor blacksmith visual tweaks"]},"v0.1.3":{description:"",changes:["Fix for flickering icons in chrome","Reformatted the Blacksmith a tad","Skills now revert to normal attacks when you run out of mana","Inn restores mana"]}},EnemyManager={numEnemies:9,enemyDefs:{},curArea:null,enemies:[],activeEnemies:[],jqField:null,jqAdventure:null,subArea:0,bestAvailableSubArea:0,getAppropriateEnemy:function(){return this.enemyDefs[this.curArea.getRandomEnemy(this.subArea)]},init:function(){this.jqField=$(".field"),this.jqAdventure=$(".adventure"),this.enemyDefs=loadEnemies(),this.curArea=AdventureScreen.adventures[0];var a="";a+='<h2 id="area-name"></h2>'+getButtonHtml("AdventureScreen.setScreen('map-select')","Map","map-button")+getButtonHtml("EnemyManager.decreaseLevel()","Back","dec-level")+getButtonHtml("EnemyManager.increaseLevel()","Forward","inc-level"),a+='<div class="spawn-area">',this.enemies=[];for(var b=0;b<this.numEnemies;b++){var c=new EnemyContainer(b);this.enemies.push(c),a+=c.getHtml()}a+="</div>",this.jqField.html(a),j(".enemy").click(function(){var a=$(this).attr("index");EnemyManager.enemies[a].onClick()})},update:function(){this.curArea&&0===this.activeEnemies.length&&(this.bestAvailableSubArea=Math.max(this.subArea+1,this.bestAvailableSubArea),this.bestAvailableSubArea>=this.curArea.subAreas.length&&this.curArea.onClear(),this.updateHeaderButtons(),this.spawnEnemies())},resetField:function(){null!==this.curArea&&(this.subArea=0,this.bestAvailableSubArea=-1,this.spawnEnemies(),this.updateUI())},spawnEnemies:function(){this.activeEnemies=[];var a=Math.min(this.enemies.length,this.curArea.getRandomSpawnCount(this.subArea));
j(".enemy-container").hide();for(var b=0;a>b;b++){var c=this.enemies[b];c.getSelector().show(),c.respawn(this.getAppropriateEnemy()),this.activeEnemies.push(c)}},despawnEnemy:function(a){removeItem(a,this.activeEnemies),a.getSelector().hide()},updateUI:function(){this.updateHeaderButtons()},updateHeaderButtons:function(){j("#area-name","text",this.curArea.displayName),j("#dec-level","toggle",this.subArea>0),j("#inc-level").toggle(this.subArea<this.bestAvailableSubArea).find(".content").text(this.subArea+1<this.curArea.subAreas.length?"Forward":"Area Complete")},decreaseLevel:function(){this.subArea--,this.spawnEnemies(),this.updateUI()},increaseLevel:function(){this.subArea+1<this.curArea.subAreas.length?(this.subArea++,this.spawnEnemies(),this.updateUI()):AdventureScreen.setScreen("map-select")}};$(document).ready(function(){$(".particles").html(ParticleContainer.getHtml()),Game.init()});var Game={toSave:["Player","Inventory","AdventureScreen","Save","Village","Blacksmith","Mastery","Skills","Buffs","Options"],realtimeDt:33,normalDt:100,veryLongDt:3e4,dT:100,mouse:{x:0,y:0},init:function(){Log.init(),Menu.init(),EnemyManager.init(),Inventory.init(),Village.init(),Mastery.init(),Blacksmith.init(),Skills.init(),Buffs.init(),Player.init(),Save.load(),Player.refreshResourceProduction(),window.setInterval(Game.update,Game.normalDt),window.setInterval(Game.realtimeUpdate,Game.realtimeDt),window.setInterval(Game.veryLongUpdate,Game.veryLongDt),$(window).resize(function(){Game.handleResize()}),$(document).keypress(function(a){Game.keyPressed(String.fromCharCode(a.which).toLowerCase())}).on("mousemove",function(a){Game.mouseMoved(a.pageX,a.pageY)}),Game.update(),ga("set","dimension1",Save.currentSaveVersion)},update:function(){var a=Date.now();return function(){Game.dT=(Date.now()-a)/1e3,Player.update(),Inventory.update(),Village.update(),Mastery.update(),Blacksmith.update(),Skills.update(),Buffs.update(),EnemyManager.update(),Menu.update(),AdventureScreen.update(),Save.update(),a=Date.now()}}(),realtimeUpdate:function(){TimerManager.update()},veryLongUpdate:function(){$.getJSON("update.json",function(a){if(a&&a.version&&Save.isNewerVersion(a.version,Save.currentSaveVersion)){for(var b="<h4>New Update! (refresh to get it) - "+a.version+"</h4><i>"+a.description+"</i><ul>",c=0;c<a.changes.length;c++)b+="<li>"+a.changes[c]+"</li>";b+="</ul>",j(".update","toggle",!0),j(".update","html",b)}}),ga("set","dimension2",Player.getLevel())},handleResize:function(){var a={};foreach(EnemyManager.activeEnemies,function(b){b.handleResize(a)})},keyPressed:function(a){Skills.keyPressed(a)},mouseMoved:function(a,b){this.mouse={x:a,y:b}}},Inventory={toSave:["items"],items:{},slotsPerItem:3,init:function(){this.items=loadItems(),this.setupButtons()},postLoad:function(){for(var a in this.items)this.items[a].update();if(Save.isSaveOlderThan("0.2.9")){var b=loadItems();for(a in b)void 0!==b[a].curCount&&(this.items[a].count=b[a].count)}},update:function(){this.updateButtons()},setupButtons:function(){var a="",b="";for(var c in this.items){var d=this.items[c];a+=d.getButtonHtml(),b+=d.getStoreButtonHtml()}j(".inventory").html(a),j(".recipes").html(b)},updateButtons:function(){for(var a in this.items){var b=this.items[a];b.updateButtons()}},getItem:function(a){return this.items[a]},useItem:function(a){var b=this.getItem(a);b&&b.canUse()&&(b.isConsumed&&(b.count-=1),b.onUse(),this.updateButtons())},tryPurchase:function(a){this.getItem(a).tryPurchase()}},LZString={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",_f:String.fromCharCode,compressToBase64:function(a){if(null==a)return"";var b,c,d,e,f,g,h,i="",j=0;for(a=this.compress(a);j<2*a.length;)0==j%2?(b=a.charCodeAt(j/2)>>8,c=255&a.charCodeAt(j/2),d=j/2+1<a.length?a.charCodeAt(j/2+1)>>8:0/0):(b=255&a.charCodeAt((j-1)/2),(j+1)/2<a.length?(c=a.charCodeAt((j+1)/2)>>8,d=255&a.charCodeAt((j+1)/2)):c=d=0/0),j+=3,e=b>>2,f=(3&b)<<4|c>>4,g=(15&c)<<2|d>>6,h=63&d,isNaN(c)?g=h=64:isNaN(d)&&(h=64),i=i+this._keyStr.charAt(e)+this._keyStr.charAt(f)+this._keyStr.charAt(g)+this._keyStr.charAt(h);return i},decompressFromBase64:function(a){if(null==a)return"";var b,c,d,e,f,g,h,i,j="",k=0,l=0,m=this._f;for(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");l<a.length;)f=this._keyStr.indexOf(a.charAt(l++)),g=this._keyStr.indexOf(a.charAt(l++)),h=this._keyStr.indexOf(a.charAt(l++)),i=this._keyStr.indexOf(a.charAt(l++)),c=f<<2|g>>4,d=(15&g)<<4|h>>2,e=(3&h)<<6|i,0==k%2?(b=c<<8,64!=h&&(j+=m(b|d)),64!=i&&(b=e<<8)):(j+=m(b|c),64!=h&&(b=d<<8),64!=i&&(j+=m(b|e))),k+=3;return this.decompress(j)},compress:function(a){if(null==a)return"";var b,c,d,e={},f={},g="",h="",i="",j=2,k=3,l=2,m="",n=0,o=0,p=this._f;for(d=0;d<a.length;d+=1)if(g=a.charAt(d),Object.prototype.hasOwnProperty.call(e,g)||(e[g]=k++,f[g]=!0),h=i+g,Object.prototype.hasOwnProperty.call(e,h))i=h;else{if(Object.prototype.hasOwnProperty.call(f,i)){if(i.charCodeAt(0)<256){for(b=0;l>b;b++)n<<=1,15==o?(o=0,m+=p(n),n=0):o++;for(c=i.charCodeAt(0),b=0;8>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1}else{for(c=1,b=0;l>b;b++)n=n<<1|c,15==o?(o=0,m+=p(n),n=0):o++,c=0;for(c=i.charCodeAt(0),b=0;16>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1}j--,0==j&&(j=Math.pow(2,l),l++),delete f[i]}else for(c=e[i],b=0;l>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1;j--,0==j&&(j=Math.pow(2,l),l++),e[h]=k++,i=String(g)}if(""!==i){if(Object.prototype.hasOwnProperty.call(f,i)){if(i.charCodeAt(0)<256){for(b=0;l>b;b++)n<<=1,15==o?(o=0,m+=p(n),n=0):o++;for(c=i.charCodeAt(0),b=0;8>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1}else{for(c=1,b=0;l>b;b++)n=n<<1|c,15==o?(o=0,m+=p(n),n=0):o++,c=0;for(c=i.charCodeAt(0),b=0;16>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1}j--,0==j&&(j=Math.pow(2,l),l++),delete f[i]}else for(c=e[i],b=0;l>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1;j--,0==j&&(j=Math.pow(2,l),l++)}for(c=2,b=0;l>b;b++)n=n<<1|1&c,15==o?(o=0,m+=p(n),n=0):o++,c>>=1;for(;;){if(n<<=1,15==o){m+=p(n);break}o++}return m},decompress:function(a){if(null==a)return"";var b,c,d,e,f,g,h,i,j=[],k=4,l=4,m=3,n="",o="",p=this._f,q={string:a,val:a.charCodeAt(0),position:32768,index:1};for(c=0;3>c;c+=1)j[c]=c;for(e=0,g=Math.pow(2,2),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;switch(b=e){case 0:for(e=0,g=Math.pow(2,8),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;i=p(e);break;case 1:for(e=0,g=Math.pow(2,16),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;i=p(e);break;case 2:return""}for(j[3]=i,d=o=i;;){if(q.index>q.string.length)return"";for(e=0,g=Math.pow(2,m),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;switch(i=e){case 0:for(e=0,g=Math.pow(2,8),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;j[l++]=p(e),i=l-1,k--;break;case 1:for(e=0,g=Math.pow(2,16),h=1;h!=g;)f=q.val&q.position,q.position>>=1,0==q.position&&(q.position=32768,q.val=q.string.charCodeAt(q.index++)),e|=(f>0?1:0)*h,h<<=1;j[l++]=p(e),i=l-1,k--;break;case 2:return o}if(0==k&&(k=Math.pow(2,m),m++),j[i])n=j[i];else{if(i!==l)return null;n=d+d.charAt(0)}o+=n,j[l++]=d+n.charAt(0),k--,d=n,0==k&&(k=Math.pow(2,m),m++)}}},Log={maxLines:5,inUse:{},lastSet:0,init:function(){for(var a="",b=0;b<this.maxLines;b++)a+='<div class="log-message" id="'+b+'"></div>';j(".game-log").html(a)},write:function(a){for(var b=(this.lastSet-1+this.maxLines)%this.maxLines,c=this.maxLines-1;c>=0;c--)if(!this.inUse[c]){b=c;break}j(".log-message#"+b).text(a).stop(!0,!0).css({opacity:0}).animate({opacity:"1"},{duration:500}).animate({opacity:"1"},{duration:1e3}).animate({opacity:"0"},{duration:1e3,complete:function(){var a=$(this).attr("id");Log.inUse[a]=!1}}),this.lastSet=b,this.inUse[b]=!0}},ParticleContainer={curParticle:0,maxParticles:60,particles:null,getHtml:function(){for(var a="",b=0;b<this.maxParticles;b++)a+='<div id="particle-'+b+'"></div>';return a},getNextParticle:function(){if(!this.particles){this.particles=[];for(var a=0;a<this.maxParticles;a++){var b="#particle-"+a;this.particles.push(j(b))}}var c=this.particles[this.curParticle%this.maxParticles];return this.curParticle++,c},create:function(a,b,c,d){var e=d+64,f=this.getNextParticle(),g=f[0].style;f.html(b).attr("class","particle "+a.className).css("transform",""),g.left=c+"px",g.top=e+"px",g.opacity=1,TimerManager.create(function(){var b=a.animHeight,c=ParticleContainer.curParticle-1;return function(a){return c+ParticleContainer.maxParticles<=ParticleContainer.curParticle?(g.opacity=0,!0):(g.opacity=1-a,g.top=e-b*a+"px",void 0)}}(),a.animTime)},createEffect:function(a,b){if(Options.fancyGraphics){var c='style="'+(b.w?"width:"+b.w+"px;":"")+(b.h?"height:"+b.h+"px;":"")+'"',d=this.getNextParticle(),e=d[0].style;d.html('<img src="'+a+'" '+c+"></img>").attr("class","particle").css("transform","rotate("+(b.deg||0)+"deg)"),e.left=(b.x||0)+"px",e.top=(b.y||0)+"px",e.opacity=1,TimerManager.create(function(){var a=ParticleContainer.curParticle-1;return function(b){return a+ParticleContainer.maxParticles<=ParticleContainer.curParticle&&(b=1),e.opacity=1-b,b>=1}}(),b.fadeTime||750)}}},damageParticleType=new ParticleType({className:"damage enemy-damage",animHeight:140,animTime:650}),critParticleType=new ParticleType({className:"damage enemy-crit",animHeight:160,animTime:650}),playerDamageParticleType=new ParticleType({className:"damage player-damage",animHeight:-90,animTime:850}),healParticleType=new ParticleType({className:"damage heal",animHeight:-75,animTime:500}),manaParticleType=new ParticleType({className:"damage mana",animHeight:-90,animTime:850}),rewardParticleType=new ParticleType({className:"reward",animHeight:-70,animTime:1400}),getIconHtml=function(){var a={},b="",c={xp:"XP_text.png",gold:"Gold_icon.png",research:"Goop.png",iron:"Iron.png",wood:"Log.png",skill:"SP.png"};return function(d){return a[d]||(a[d]='<img class="icon '+d+'-icon" src="'+b+c[d]+'" alt="'+d+'"/>'),a[d]}}(),Player={toSave:["health","mana","weaponName"],health:100,baseHealthRegen:3,partialHealth:0,mana:100,baseManaRegen:5,partialMana:0,weaponName:"stick",weapon:null,attackName:"attack",attack:null,armor:2,randDamage:.3,critDamage:50,stats:[],resources:["xp","skill","gold","research","iron","wood"],init:function(){var a=loadStats();for(var b in a)this.stats.push(b),this[b]=a[b],this.toSave.push(b);foreach(this.resources,function(a){Player[a]={toSave:["amount"],amount:0,partial:0,perSecond:0,unlocked:!1,unlockBuilding:""},Player.toSave.push(a)}),this.xp.unlocked=!0,this.gold.unlocked=!0,this.skill.unlockBuilding="training-hall",this.research.unlockBuilding="research-center",this.iron.unlockBuilding="forge",this.wood.unlockBuilding="logger",this.createStatButtons();var c='<div>Level: <span id="stat-level"></span></div>';foreach(this.resources,function(a){c+='<div id="'+a+'-stat">'+getIconHtml(a)+': <span id="'+a+'-amount"></span></div>'}),c+='<div id="resources"></div><br><div>Weapon : <span id="stat-weapon"></span></div><div>Skill : <span id="stat-skill"></span></div><br><div>Damage : <span id="stat-damage"></span></div><br><div>Crit. Chance : <span id="stat-crit"></span></div><div>Crit Damage : <span id="stat-crit-damage"></span></div><br><div>Attack Power : <span id="stat-attackpower"></span></div><div>Spell Power : <span id="stat-spellpower"></span></div><div>Defense Power : <span id="stat-defense"></span></div><br><div>Armor : <span id="stat-armor"></span></div><br><div>Health Regen: <span id="stat-regen"></span></div><div>Mana Regen: <span id="stat-mana-regen"></span></div><div>Damage Reduction: <span id="stat-reduction"></span></div><br>',j("#stats").html(c),this.update()},update:function(){this.weapon=Blacksmith.getWeapon(this.weaponName),this.attack=Skills.getSkill(this.attackName);var a=Game.dT;this.regenHealth(this.getHealthRegen()*a),this.regenMana(this.getManaRegen()*a),j("#player-health","text",formatNumber(this.health)+" / "+formatNumber(this.getMaxHealth())),j("#player-health","css","width",100*(this.health/this.getMaxHealth())+"%"),j("#player-mana","text",formatNumber(this.mana)+" / "+formatNumber(this.getMaxMana())),j("#player-mana","css","width",100*(this.mana/this.getMaxMana())+"%"),this.updateResources(),this.updateStats(),this.updateStatButtons()},updateResources:function(){var a=Game.dT;foreach(this.resources,function(b){var c=Player[b];c.partial+=c.perSecond*a;var d=Math.floor(c.partial);c.amount+=d,c.partial-=d})},refreshResourceProduction:function(){foreach(this.resources,function(a){var b=Player[a];if(b.perSecond=0,!b.unlocked){var c=Village.buildings[b.unlockBuilding];c&&c.count>0&&(b.unlocked=!0)}}),foreach(Village.buildings,function(a){var b=a.resourceProduced;b&&(Player[b].perSecond+=a.count*a.getProduction()*Buffs.getMult(b+"Income"))})},canSpend:function(a,b){return this[a]&&this[a].amount>=b},spend:function(a,b,c){return this.canSpend(a,b)?(this[a].amount-=b,c&&c(),!0):!1},giveResources:function(a){foreach(a,function(a,b){Player[b]&&(Player[b].amount+=a)}),a.skill&&this.weapon.type.addXp(a.skill)},updateStats:function(){j("#stat-level","text",formatNumber(Player.getLevel())),foreach(this.resources,function(a){var b=Player[a];j("#"+a+"-stat","toggle",b.unlocked);var c=formatNumber(b.amount);b.perSecond>0&&(c+=" (+"+formatNumber(b.perSecond)+"/s)"),j("#"+a+"-amount","text",c)}),j("#stat-weapon","text",this.weapon.getName()),j("#stat-skill","text",this.attack.displayName);var a=this.getDamageInfo();j("#stat-damage","text",formatNumber(a.lo)+" - "+formatNumber(a.hi));var b=formatNumber(a.crit)+"%",c="+"+formatNumber(a.critBonusHi)+"%";a.critBonusLo>0&&(b+="<br>Base Crit: "+formatNumber(a.preWrapCrit)+"%",c="+"+formatNumber(a.critBonusLo)+" / "+formatNumber(a.critBonusHi)+"%"),j("#stat-crit","html",b),j("#stat-crit-damage","html",c),j("#stat-attackpower","text",formatNumber(a.attackPower)),j("#stat-spellpower","text",formatNumber(a.spellPower)),j("#stat-defense","text",formatNumber(this.getDefensePower())),j("#stat-armor","text",formatNumber(Player.armor)),j("#stat-regen","text","+"+formatNumber(this.getHealthRegen())+"/s"),j("#stat-mana-regen","text","+"+formatNumber(this.getManaRegen())+"/s"),j("#stat-reduction","text",formatNumber(100*(1-this.defenseDamageMultiplier()))+"%")},getStat:function(a){return this[this.stats[a]]},getLevel:function(){for(var a=1,b=0;b<this.stats.length;b++)a+=this.getStat(b).level;return a},regenHealth:function(a){this.partialHealth+=a;var b=Math.floor(this.partialHealth);return this.partialHealth-=b,this.health=Math.min(this.health+b,this.getMaxHealth()),b},regenMana:function(a){this.partialMana+=a;var b=Math.floor(this.partialMana);return this.partialMana-=b,this.mana=Math.min(this.mana+b,this.getMaxMana()),b},addHealth:function(a){this.regenHealth(a),a&&this.createAddHealthParticle(a)},getMaxHealth:function(){return Math.floor(this.weapon.getMult("maxHealth")*Skills.getPassiveMult("maxHealth")*((Skills.getPassiveMult("healthPerLevel")-1)*Player.getLevel()+1)*this.maxHealth.getTotalBonus())},getMaxMana:function(){return Math.floor(this.weapon.getMult("maxMana")*Skills.getPassiveMult("maxMana")*this.maxMana.getTotalBonus())},getHealthRegen:function(){return this.weapon.getMult("healthRegen")*Skills.getPassiveMult("healthRegen")*Buffs.getMult("healthRegen")*(this.baseHealthRegen+this.defense.getTotalBonus()+Skills.getPassiveBase("healthRegen")/100*this.getMaxHealth())},getManaRegen:function(){return this.weapon.getMult("manaRegen")*Skills.getPassiveMult("manaRegen")*Buffs.getMult("manaRegen")*(this.baseManaRegen+this.wisdom.getTotalBonus()+Skills.getPassiveBase("manaRegen")/100*this.getMaxMana())},getDamageInfo:function(a){a=a||1;var b={attackPower:Math.floor(this.weapon.getDamage()*this.strength.getBonusMult()*Skills.getPassiveMult("attack")),spellPower:Math.floor(Skills.getPassiveMult("spellPower")*this.intelligence.getBonusMult()*this.weapon.getSpellPower()),isSpell:"Spell"===this.attack.category},c=1;for(b.isSpell?(b.power=b.spellPower,b.baseCrit=this.attack.getBaseCrit()):(b.power=b.attackPower,c*=this.weapon.getMult("maxDamage"),b.baseCrit=this.weapon.getBaseCrit()),b.baseDamage=b.power*this.weapon.getMult("damage")*Skills.getPassiveMult("damage")*Buffs.getMult("damage")*this.attack.getDamage()/100*a,b.preWrapCrit=(b.baseCrit+Skills.getPassiveBase("crit"))*this.weapon.getMult("crit")*this.attack.getBonusMult("crit")*Skills.getPassiveMult("crit"),b.critWrap=-1,b.crit=b.preWrapCrit;b.crit>100;)b.crit/=2,b.critWrap+=1;var d=this.getCritDamage();return b.critBonusLo=-1===b.critWrap?0:d*Math.pow(2,b.critWrap),b.critBonusHi=d*Math.pow(2,b.critWrap+1),c*=this.attack.getBonusMult("maxDamage"),b.lo=Math.ceil(b.baseDamage*(1-this.randDamage/2)),b.hi=Math.floor(c*b.baseDamage*(1+this.randDamage/2)),b.isCrit=rand(0,100)<b.crit,b.damage=randIntInc(b.lo,b.hi),b.damage=Math.floor(b.damage*(1+(b.isCrit?b.critBonusHi:b.critBonusLo)/100)),b},getCritDamage:function(){return this.weapon.getFlatUpgradeAmount("critDamage")+Skills.getPassiveBase("critDamage")+this.dexterity.getTotalBonus()+this.critDamage},getDefensePower:function(){return Math.floor(this.weapon.getMult("defense")*Skills.getPassiveMult("defense")*(12+6*this.defense.value()+this.getLevel()))},defenseDamageMultiplier:function(){return 40/(40+this.getDefensePower())},tryAttack:function(a){var b=a.attackPower(),c=Math.ceil(b*this.defenseDamageMultiplier())-this.armor;c=Math.max(c,1),a.isActive()&&(this.health<=c?a.showMessage("Need HP"):this.mana<this.attack.getManaCost()?(a.showMessage("Need Mana"),Options.resetToAttack&&(this.attack=Skills.getSkill("attack"),this.tryAttack(a))):(this.addMana(-this.attack.getManaCost()),"attack"===this.attack.name&&this.addMana(Skills.getPassiveBase("attackMana")),this.takeDamage(c),this.attack.doAttack(a)))},takeDamage:function(a){this.addHealth(-a)},addMana:function(a){this.regenMana(a),a&&this.createAddManaParticle(a)},createAddHealthParticle:function(a){var b=j("#player-health"),c=b.position(),d=b.width(),e=b.height(),f=c.left+d-8,g=c.top+e/2,h=a>0?healParticleType:playerDamageParticleType,i=a>0?"+":"";ParticleContainer.create(h,i+formatNumber(a),f,g)},createAddManaParticle:function(a){var b=j("#player-mana"),c=b.position(),d=b.width(),e=b.height(),f=c.left+d-8,g=c.top+e/2,h=a>0?"+":"";ParticleContainer.create(manaParticleType,h+formatNumber(a),f,g)},upgrade:function(a){for(var b=0;b<this.stats.length;b++){var c=this.getStat(b);c.name==a&&c.tryUpgrade()}},createStatButtons:function(){for(var a="",b=0;b<this.stats.length;b++)a+=this.getStat(b).getUpgradeButtonHtml();$("#stat-buttons").html(a),this.updateStatButtons()},updateStatButtons:function(){for(var a=0;a<this.stats.length;a++)this.getStat(a).updateButton()},statUpgradeBaseCost:function(){var a=this.getLevel();return Math.floor(.5*(a-1)+.2*Math.pow(a-1,2.3))},resetStats:function(){var a=confirm("Are you sure? There's no bonuses, and you don't get an XP refund.");if(a){for(var b=0;b<this.stats.length;b++)this.getStat(b).level=0;this.updateStatButtons()}}},Save={toSave:["autosave"],currentSaveVersion:"0.2.11",loadedSaveVersion:"0.2.11",autosave:!0,autoDt:3e4,autoTimer:0,update:function(){this.autosave&&(this.autoTimer+=Game.normalDt,this.autoTimer>=this.autoDt&&(this.autoTimer-=this.autoDt,this.save()))},getSaveObject:function(a){if(null===a)return null;var b=a.toSave||Object.keys(a),c={};for(var d in a)(b[d]||!b.indexOf||b.indexOf(d)>=0)&&(c[d]="object"==typeof a[d]?this.getSaveObject(a[d]):a[d]);return c},restoreFromSaveObject:function(a,b){if(a&&b){var c=a.toSave||Object.keys(a);for(var d in b)(c[d]||!c.indexOf||c.indexOf(d)>=0)&&("object"==typeof a[d]?this.restoreFromSaveObject(a[d],b[d]):a[d]=b[d]);a.postLoad&&a.postLoad()}},save:function(){localStorage.saveString=this.getSaveString(),Log.write("Game Saved")},getFullSaveObject:function(){for(var obj={saveVersion:this.currentSaveVersion},i=0;i<Game.toSave.length;i++){var key=Game.toSave[i];obj[key]=this.getSaveObject(eval(key))}return obj},getPreHashSaveString:function(){return JSON.stringify(this.getFullSaveObject())},getSaveString:function(){return LZString.compressToBase64(this.getPreHashSaveString())},getSavedString:function(){return localStorage.saveString},saveExists:function(){return localStorage.saveString?!0:!1},clearSave:function(){delete localStorage.saveString,this.autosave=!1},load:function(){localStorage.saveString&&Save.import(localStorage.saveString)},isSaveOlderThan:function(a){return this.isNewerVersion(a,this.loadedSaveVersion)},isNewerVersion:function(a,b){for(var c=a.split("."),d=b.split("."),e=0;e<c.length;e++){var f=Math.floor(c[e]),g=Math.floor(d[e]);if(f>g)return!0;if(g>f)return!1}return!1},"import":function(str){if(str&&""!==str){var baseStr=LZString.decompressFromBase64(str);this.loadedSaveVersion=this.currentSaveVersion;try{if(null===baseStr||""===baseStr)throw"Load failed! Invalid import string";var restoredObject=JSON.parse(baseStr);if(this.isNewerVersion(restoredObject.saveVersion,this.currentSaveVersion))throw"Load failed! Saved version is greater than current version. Old version is: "+restoredObject.saveVersion;this.loadedSaveVersion=restoredObject.saveVersion;for(var i=0;i<Game.toSave.length;i++){var key=Game.toSave[i],obj=eval(key);this.restoreFromSaveObject(obj,restoredObject[key])}}catch(exception){"string"==typeof exception?alert(exception):alert("Load failed! Unparseable save data"),this.autosave=!1}}}},AdventureScreen=new ScreenContainer({classBase:"adventure-screen",targetDiv:".adventure",screens:[new ScreenDef({name:"map-select",createHtml:mapSelectHtml}),new ScreenDef({name:"field"}),new ScreenDef({name:"inn",displayName:"Inn",html:getButtonHtml("AdventureScreen.setScreen('map-select')","Leave")+"<br>"+getButtonHtml("AdventureScreen.useInn()",'Rest: <span id="inn-cost"></span>'+getIconHtml("gold"),"","gold")+'<div>Inn cost reduced in <span id="inn-reset"></span>s</div>'}),new ScreenDef({name:"store",displayName:"Store",html:getButtonHtml("AdventureScreen.setScreen('map-select')","Leave")+'<br><div class="recipes"></div>',adventuresBlock:!0,prereqs:{adventures:["adv1"]}}),new ScreenDef({name:"witch",displayName:"Witch's Cave",prereqs:{adventures:["adv2"]}}),new ScreenDef({name:"shrine",displayName:"Demon Shrine",createHtml:shrineHtml,prereqs:{adventures:["adv2"]}}),new ScreenDef({name:"mortal-shrine",displayName:"Mortal Shrine",html:getButtonHtml("AdventureScreen.setScreen('map-select')","Leave")+"<br>Reset all stats? "+getButtonHtml("Player.resetStats()","Reset"),prereqs:{adventures:["adv4"]}})],adventures:{},preInit:function(){this.categorizedAdventures=loadAdventures(),this.adventures={},foreach(this.categorizedAdventures,function(a){AdventureScreen.adventures=merge(AdventureScreen.adventures,a)}),this.lastInnResetTime=Date.now()},update:function(){this.updateScreens();var a=Date.now()-this.lastInnResetTime,b=this.innResetTime-a;0>b&&(b=0,this.innUseCount=Math.floor(.85*this.innUseCount),this.lastInnResetTime=Date.now()),j("#inn-reset","text",formatNumber(Math.floor(b/1e3))),j("#inn-cost","text",formatNumber(this.getInnCost())),foreach(this.categorizedAdventures,function(a,b){var c=!1;foreach(a,function(a){a.update(),c=c||a.isAvailable()}),j(".cat-"+b,"toggle",c)})},onScreenSet:function(a){this.isOpen("field")||"field"!=a?this.isOpen("field")&&"field"!=a&&EnemyManager.curArea&&(j(".field").toggleClass(EnemyManager.curArea.areaType,!1),EnemyManager.curArea=null):EnemyManager.resetField(),this.curScreen=a}});AdventureScreen.toSave=["adventures","innUseCount"],AdventureScreen.lastInnResetTime=0,AdventureScreen.innUseCount=0,AdventureScreen.innResetTime=3e5,AdventureScreen.getAdventure=function(a){for(var b in this.adventures){var c=this.adventures[b];if(c.name==a)return c}return null},AdventureScreen.hasBeat=function(a){var b=this.getAdventure(a);return b&&b.beatOnPower>=0},AdventureScreen.startAdventure=function(a){var b=this.getAdventure(a);EnemyManager.curArea&&j(".field").toggleClass(EnemyManager.curArea.areaType,!1),j(".field").toggleClass(b.areaType,!0),EnemyManager.curArea=b,this.setScreen("field")},AdventureScreen.increasePower=function(a){var b=this.getAdventure(a);Player.spend("research",b.powerUpCost(),function(){b.power++})},AdventureScreen.decreasePower=function(a){var b=this.getAdventure(a);b.power>0&&b.power--},AdventureScreen.useInn=function(){var a=Player.health<Player.getMaxHealth()||Player.mana<Player.getMaxMana();a||foreach(Inventory.items,function(b){a=a||void 0!==b.curCount&&b.count!=b.curCount}),a&&Player.spend("gold",this.getInnCost(),function(){Player.health=Player.getMaxHealth(),Player.mana=Player.getMaxMana(),AdventureScreen.innUseCount++,foreach(Inventory.items,function(a){void 0!==a.curCount&&(a.curCount=a.count)})})},AdventureScreen.getInnCost=function(){var a=Player.getLevel()-1,b=10+a+.05*Math.pow(a,1.6);return Math.floor(b*Math.pow(1.4,this.innUseCount))},AdventureScreen.isAdventuring=function(){return"field"==this.curScreen};var Blacksmith={toSave:["weapons"],weapons:{},init:function(){this.weapons=loadWeapons(),this.setupButtons()},update:function(){this.updateButtons()},setupButtons:function(){var a="";foreach(this.weapons,function(b){a+=b.getButtonHtml()}),j(".blacksmith").html(a),this.updateButtons()},updateButtons:function(){foreach(this.weapons,function(a){a.updateButton()})},getWeapon:function(a){return this.weapons[a]},equip:function(a){this.getWeapon(a).owned&&(Player.weaponName=a)},tryPurchase:function(a){var b=this.getWeapon(a);b.canPurchase()&&Player.spend(b.getCurrency(),b.getCost(),function(){b.purchase(),b.owned&&(Player.weaponName=a)})}},getUpgradeName=function(){var a={damage:"Damage",attack:"Attack Power",maxDamage:"Max Damage",crit:"Crit. Chance",critDamage:"Crit. Damage",defense:"Defense",maxHealth:"Max Health",healthRegen:"Health Regen",maxMana:"Max Mana",manaRegen:"Mana Regen",spellPower:"Spell Power",itemEffeciency:"Item Efficiency",xpIncome:"XP Gain",goldIncome:"Gold Gain"};return function(b){return a[b]||b}}(),getStatClass=function(){var a=["strength","dexterity"],b=["intelligence","wisdom"];return function(c){return-1!==a.indexOf(c)?"physical":-1!==b.indexOf(c)?"mental":""}}(),Buffs={toSave:["buffs"],init:function(){this.buffs=loadBuffs(),this.setupButtons()},setupButtons:function(){var a=getButtonHtml("AdventureScreen.setScreen('map-select')","Leave")+"<br>";foreach(this.buffs,function(b){a+=b.getButtonHtml()}),j(".witch").html(a)},update:function(){foreach(this.buffs,function(a){a.update()})},activateBuff:function(a){this.buffs[a]&&this.buffs[a].activate()},getMult:function(a){var b=1;return foreach(this.buffs,function(c){c.isActivated()&&(b*=1+c.getBonus(a)/100)}),b}},Mastery={toSave:["weaponTypes"],weaponTypes:{},init:function(){this.weaponTypes=loadWeaponTypes(),this.setupButtons()},update:function(){this.updateButtons()},setupButtons:function(){var a="";foreach(this.weaponTypes,function(b){a+=b.getButtonHtml()}),j(".mastery").html(a)},updateButtons:function(){foreach(this.weaponTypes,function(a){a.updateButton()})}},Menu=new ScreenContainer({screens:[new ScreenDef({name:"adventure",displayName:"Adventure"}),new ScreenDef({name:"blacksmith",displayName:"Blacksmith",prereqs:{adventures:["sid1"]}}),new ScreenDef({name:"mastery",displayName:"Masteries",prereqs:{buildings:{"training-hall":1}}}),new ScreenDef({name:"village",displayName:"Village",prereqs:{adventures:["adv0"]}}),new ScreenDef({name:"skills",displayName:"Skills",prereqs:{buildings:{"training-hall":1}}}),new ScreenDef({name:"options",displayName:"Options"}),new ScreenDef({name:"changelist",hidden:!0,createHtml:getChangelistHtml})],classBase:"screen",targetDiv:".main-area",postInit:function(){var a="";foreach(this.screens,function(b){b.hidden||(a+=getButtonHtml("Menu.setScreen('"+b.name+"')",b.displayName,b.name+"-button")+" ")}),j(".header-buttons","html",a),this.setScreen("adventure"),AdventureScreen.init(),Options.init()},update:function(){this.updateScreens(),Options.update()},onScreenSet:function(a){j("#"+this.curScreen+"-button","toggleClass","selected",!1),j("#"+a+"-button","toggleClass","selected",!0)}}),Options={toSave:["fancyGraphics","resetToAttack","showRewards"],fancyGraphics:!0,resetToAttack:!0,showRewards:{},init:function(){foreach(Player.resources,function(a){Options.showRewards[a]=!0});var a="<div>"+getButtonHtml("Save.save()","Save")+" "+getButtonHtml("Save.autosave = !Save.autosave",'Autosave: <span id="save-autosave"></span>')+'</div><div id="save-info">'+getButtonHtml("Save.clearSave()","Delete Save","del-save")+'<div>Export hash: <div class="saveArea" id="save-val"></div></div></div><div>'+getButtonHtml("Save.import($('#save-import').val())","Import")+'Import hash: <textarea class="saveArea" id="save-import"></textarea></div><div><ul><li>Fancy Graphics: <input type="checkbox" id="fancy-graphics"></input></li><li>Use basic Attack when out of Mana: <input type="checkbox" id="attack-reset"></input></li></ul></div><div>Show Rewards: <ul id="reward-options">';foreach(this.showRewards,function(b,c){a+='<li id="'+c+'">'+getIconHtml(c)+'<input type="checkbox" id="show"></input></li>'}),a+="</ul></div>",j(".options","html",a),this.postLoad()},postLoad:function(){j("#fancy-graphics").prop("checked",this.fancyGraphics),j("#attack-reset").prop("checked",this.resetToAttack),foreach(this.showRewards,function(a,b){j("#reward-options #"+b+" #show").prop("checked",a)})},update:function(){j("#save-info","toggle",Save.saveExists()),j("#save-val","text",Save.getSavedString()),j("#save-autosave","text",Save.autosave?"Enabled":"Disabled"),this.fancyGraphics=j("#fancy-graphics").prop("checked"),this.resetToAttack=j("#attack-reset").prop("checked"),foreach(this.showRewards,function(a,b){var c="#reward-options #"+b;j(c,"toggle",Player[b].unlocked),Options.showRewards[b]=j(c+" #show").prop("checked")})}},Skills={toSave:["skills"],skills:{},init:function(){this.skills=loadSkills(),this.setupButtons()},update:function(){this.updateButtons()},setupButtons:function(){var a={},b="",c="";foreach(this.skills,function(b){a[b.category]||(a[b.category]="<h3>"+b.category+"</h3>"),a[b.category]+=b.getButtonHtml(),b.isAttack()&&(c+=b.getAttackButtonHtml())}),foreach(a,function(a){b+=a}),j(".skills","html",b),j(".attacks","html",c),this.updateButtons()},updateButtons:function(){foreach(this.skills,function(a){a.updateButton()})},getSkill:function(a){return this.skills[a]},getPassiveMult:function(a){var b=1;return foreach(this.skills,function(c){"Passive"===c.category&&(b*=c.getMult(a))}),b},getPassiveBase:function(a){var b=0;return foreach(this.skills,function(c){"Passive"===c.category&&(b+=c.getBase(a))}),b},equip:function(a){var b=this.getSkill(a);b.level>0&&b.isAttack()&&(Player.attackName=a)},tryPurchase:function(a){var b=this.getSkill(a);b.canPurchase()&&Player.spend(b.getCurrency(),b.getCost(),function(){b.purchase()})},keyPressed:function(a){foreach(this.skills,function(b){return b.keyCode===a?(Skills.equip(b.name),void 0):void 0})}},Village={toSave:["buildings","upgrades"],buildings:{},upgrades:{},init:function(){this.buildings=loadBuildings(),this.upgrades=loadUpgrades(),this.setupButtons()},update:function(){this.updateButtons()},setupButtons:function(){var a={};foreach(this.buildings,function(b){a[b.sectionName]||(a[b.sectionName]=""),a[b.sectionName]+=b.getButtonHtml()}),a.Upgrades="",foreach(this.upgrades,function(b){a.Upgrades+=b.getButtonHtml()});var b="";foreach(a,function(a,c){b+="<div><h3>"+c+"</h3>"+a+"</div>"}),j(".village").html(b)},updateButtons:function(){foreach(this.buildings,function(a){a.updateButton()}),foreach(this.upgrades,function(a){a.updateButton()})},buy:function(a,b){var c=this[a][b];Player.spend(c.getCurrency(),c.getCost())&&(c.isResearched?c.count+=1:c.isResearched=!0,Player.refreshResourceProduction())
},buyBuilding:function(a){this.buy("buildings",a)},buyUpgrade:function(a){this.buy("upgrades",a)}},formatTime=function(){var a=[{single:"Day",plural:"Days",seconds:86400},{single:"Hour",plural:"Hours",seconds:3600},{single:"Minute",plural:"Minutes",seconds:60},{single:"Second",plural:"Seconds",seconds:1}];return function(b){for(var c="",d=0;d<a.length;d++){var e=a[d],f=Math.floor(b/e.seconds);b-=f*e.seconds,(f>0||""!==c||d+1>=a.length)&&(""!==c&&(c+=", "),c+=f+" "+(1===f?e.single:e.plural))}return c}}(),j=function(){var a={};return function(b){if(1==arguments.length)return b in a||(a[b]=$(b)),a[b];for(var c=arguments[1],d=b+"#"+c,e=[],f=2;f<arguments.length;f++)e.push(arguments[f]);if(a[d]!==e.toString()){a[d]=e.toString();var g=j(b)[c];g.apply(j(b),e)}}}(),TimerManager={active:[],skipFrame:0,maxSkipFrame:2,update:function(){if(Options.fancyGraphics||(this.skipFrame=(this.skipFrame+1)%this.maxSkipFrame,0===this.skipFrame))for(var a=this.active.length-1;a>=0;a--)this.active[a]()},create:function(a,b){var c=function(){var d=0;return function(){var e=Game.realtimeDt/b;Options.fancyGraphics||(e*=TimerManager.maxSkipFrame),d+=e,(a(clamp01(d))||d>=1)&&removeItem(c,TimerManager.active)}}();this.active.push(c)}};